<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Ordering - Trinity Optimum Vision Center</title>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@300;400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="CSS Styles/BaseStyles.css">
    <link rel="stylesheet" href="CSS Styles/AboutUsPageStyles.css">
    <link rel="stylesheet" href="CSS Styles/AdminPageStyles.css">
    <link rel="stylesheet" href="CSS Styles/ConfirmationStyles.css">
    <link rel="stylesheet" href="CSS Styles/ContactUsPageStyles.css">
    <link rel="stylesheet" href="CSS Styles/FrameEditStyles.css">
    <link rel="stylesheet" href="CSS Styles/FrameTypesMenuHeaderStyles.css">
    <link rel="stylesheet" href="CSS Styles/HeaderStyles.css">
    <link rel="stylesheet" href="CSS Styles/LogInModalStyles.css">
    <link rel="stylesheet" href="CSS Styles/NotificationIconPanelStyles.css">
    <link rel="stylesheet" href="CSS Styles/Pre-OrderStyles.css">
    <link rel="stylesheet" href="CSS Styles/ProductGridStyles.css">
    <link rel="stylesheet" href="CSS Styles/ResponsiveNotifStyles.css">
    <link rel="stylesheet" href="CSS Styles/SidebarStyles.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <!-- Firebase Configuration (must be loaded first) -->
    <script src="Javascript Styles/FirebaseConfig.js"></script>
    
    <!-- Application Scripts (loaded after Firebase is initialized) -->
    <script src="Javascript Styles/AuthHandlers.js"></script>
    <script src="Javascript Styles/ContentEditingFunc.js"></script>
    <script src="Javascript Styles/EventListenerFunc.js"></script>
    <script src="Javascript Styles/FrameCategoryFunc.js"></script>
    <script src="Javascript Styles/FrameEditingModal.js"></script>
    <script src="Javascript Styles/NotificationFunc.js"></script>
    <script src="Javascript Styles/PassToggleFunc.js"></script>
    <script src="Javascript Styles/Script.js"></script>
    <script src="Javascript Styles/SeachFunc.js"></script>
    <script src="Javascript Styles/SidebarFunc.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <h1 class="maintitle">T R I N I T Y</h1>
                <p class="subtitle">OPTIMUM VISION CENTER</p>
            </div>
            <nav class="nav">
                <div class="nav-left">
                    <a href="index.html" class="nav-link">
                        <span>Home</span>
                    </a>
                    <a href="contact.html" class="nav-link">
                        <span>Contact Us</span>
                    </a>
                    <a href="about.html" class="nav-link">
                        <span>About Us</span>
                    </a>

                    <a href="preorders.html" class="nav-link admin-only" id="preOrdersNav" style="display: none;">
                        <span>Pre-Orders</span>
                    </a>
                    <a href="admin-dashboard.html" class="nav-link admin-only" id="productManagementNav" style="display: none;">
                        <span>Product Management</span>
                    </a>
                </div>
                <div class="nav-right">
                    <div class="nav-icons">
                        <div class="notification-wrapper admin-only" style="display: none;">
                            <span class="notification-icon" onclick="toggleNotifications()">ðŸ””</span>
                            <span class="notification-badge" id="notificationBadge">0</span>
                        </div>
                    </div>
                    <div class="auth-section">
                        <a href="#" class="login-btn" id="authButton" onclick="handleAuthClick()">
                            <span class="user-icon">ðŸ‘¤</span>
                            <span id="authButtonText">Log In</span>
                        </a>
                        <div class="admin-dropdown" id="adminDropdown">
                            <button class="dropdown-item" onclick="navigateToPreorders()">
                                <span class="dropdown-icon">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                    </svg>
                                </span>
                                <span>Pre-Orders</span>
                            </button>

                            <button class="dropdown-item" onclick="toggleContentManagement()">
                                <span class="dropdown-icon">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                </span>
                                <span>Content Management</span>
                            </button>
                            <button class="dropdown-item" onclick="toggleUserManagement()">
                                <span class="dropdown-icon">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                                        <path d="M16 3.13a4 4 0 010 7.75"/>
                                    </svg>
                                </span>
                                <span>User Management</span>
                            </button>
                            <button class="dropdown-item" onclick="toggleAdminSettings()">
                                <span class="dropdown-icon">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M4.93 4.93l1.41 1.41M4.93 19.07l1.41-1.41M19.07 4.93l-1.41 1.41M19.07 19.07l-1.41-1.41M12 2v2M12 20v2M2 12h2M20 12h2"/>
                                    </svg>
                                </span>
                                <span>Admin Settings</span>
                            </button>
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Login Modal -->
        <div class="login-modal-overlay" id="loginModalOverlay" onclick="hideLoginModal()">
            <div class="login-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h2 class="modal-title">W E L C O M E</h2>
                </div>
                
                <form class="login-form" id="modalLoginForm">
                    <div class="input-group">
                        <span class="input-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                        </span>
                        <input type="email" placeholder="Email Address" class="login-input" id="modalEmailInput" required>
                    </div>
                    
                    <div class="input-group">
                        <span class="input-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <circle cx="12" cy="16" r="1"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                        </span>
                        <input type="password" placeholder="Password" class="login-input" id="modalPasswordInput" required>
                        <span class="password-toggle" onclick="togglePassword()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </span>
                    </div>
                    
                    <div class="remember-me-group">
                        <label class="remember-me-label">
                            <input type="checkbox" id="rememberMeCheckbox" class="remember-me-checkbox">
                            <span class="checkmark"></span>
                            Remember me
                        </label>
                    </div>
                    
                    <button type="submit" class="modal-login-btn">Log In</button>
                    
                    <div class="guest-option">
                        <span class="continue-text">Or continue as</span>
                        <button type="button" class="guest-btn" onclick="hideLoginModal()">Guest</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Pre-Order Content -->
        <main class="preorder-content">
            <h2 class="preorder-page-title">PRE-ORDERING</h2>
            
            <div class="preorder-form-container">
                <form class="preorder-page-form" id="preorderForm">
                    <div class="form-row">
                        <div class="form-column">
                            <div class="form-field">
                                <label class="field-label">Full Name</label>
                                <div class="name-inputs">
                                    <input type="text" placeholder="First Name" class="name-input" name="firstName" id="firstName" required>
                                    <input type="text" placeholder="Last Name" class="name-input" name="lastName" id="lastName" required>
                                </div>
                            </div>
                            
                            <div class="form-field">
                                <label class="field-label">Email</label>
                                <input type="email" placeholder="email@example.com" class="full-input" name="email" id="email" required>
                            </div>
                            
                            <div class="form-field">
                                <label class="field-label">Phone Number</label>
                                <input type="tel" placeholder="+63" class="full-input" name="phone" id="phone" required inputmode="numeric" autocomplete="tel" maxlength="12" pattern="^(?:639\d{9}|09\d{9})$" title="Enter a valid PH mobile number: 09XXXXXXXXX or 639XXXXXXXXX">
                            </div>
                            
                            <div class="form-field">
                                <label class="field-label">Frame Name</label>
                                <div class="autocomplete-container">
                                    <input type="text" placeholder="Frame Name or Model" class="full-input" name="frameName" id="frameName" autocomplete="off">
                                    <div class="autocomplete-dropdown" id="frameNameDropdown"></div>
                                </div>
                            </div>
                            
                            <div class="form-field">
                                <label class="field-label">Quantity</label>
                                <select class="quantity-select" name="quantity" id="quantity" required>
                                    <option value="1" selected>1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10+</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-column">
                            <div class="form-field">
                                <label class="field-label">Prescription (Optional)</label>
                                <textarea placeholder="Enter prescription details if available..." class="note-textarea" name="prescription" id="prescription"></textarea>
                            </div>
                            
                            <div class="form-field">
                                <label class="field-label">Additional Notes</label>
                                <textarea placeholder="Add your note here..." class="note-textarea" name="notes" id="notes"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Submit</button>
                        <button type="button" class="cancel-btn" onclick="window.history.back()">Cancel</button>
                    </div>
                    
                    <div id="formMessage" class="form-message"></div>
                </form>
            </div>
        </main>
    </div>
    
    <script>
        let allFrameNames = [];
        let isDropdownVisible = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            const preorderForm = document.getElementById('preorderForm');
            const phoneInput = document.getElementById('phone');
            
            // Enforce digits-only input for phone field
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    const digitsOnly = e.target.value.replace(/\D/g, '');
                    e.target.value = digitsOnly;
                });
            }
            
            // Load frame names from database
            loadFrameNames();
            
            // Set up auto-suggestion for frame name input
            setupFrameNameAutocomplete();
            
            // Auto-fill frame name if passed via URL parameter
            autoFillFrameName();
            
            if (preorderForm) {
                preorderForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Get form values
                    const firstName = document.getElementById('firstName').value;
                    const lastName = document.getElementById('lastName').value;
                    const email = document.getElementById('email').value;
                    const phone = document.getElementById('phone').value;
                    const frameName = document.getElementById('frameName').value;
                    const quantity = document.getElementById('quantity').value;
                    const prescription = document.getElementById('prescription').value;
                    const notes = document.getElementById('notes').value;
                    
                    // Validate PH mobile number: allow formats 09XXXXXXXXX or 639XXXXXXXXX
                    const normalizedPhone = phone.replace(/\D/g, '');
                    const isValidPHMobile = /^(?:639\d{9}|09\d{9})$/.test(normalizedPhone);
                    if (!isValidPHMobile) {
                        const fm = document.getElementById('formMessage');
                        if (fm) {
                            fm.textContent = 'Please enter a valid Philippine mobile number (09XXXXXXXXX or 639XXXXXXXXX).';
                            fm.className = 'form-message error';
                        }
                        return;
                    }

                    // Create pre-order object
                    const preOrder = {
                        firstName: firstName,
                        lastName: lastName,
                        email: email,
                        phone: normalizedPhone,
                        frameName: frameName,
                        quantity: quantity,
                        prescription: prescription,
                        notes: notes,
                        date: new Date().toISOString(),
                        status: 'pending'
                    };
                    
                    // Save to Firebase using centralized service and show messages
                    const formMessage = document.getElementById('formMessage');
                    if (formMessage) {
                        formMessage.textContent = 'Submitting your pre-order...';
                        formMessage.className = 'form-message info';
                    }

                    firebaseServices.savePreOrderToFirebase(preOrder)
                        .then(({ key }) => {
                            console.log('Pre-order saved successfully with ID:', key);

                            if (formMessage) {
                                formMessage.textContent = 'Pre-order submitted successfully!';
                                formMessage.className = 'form-message success';
                            }

                            // Create a notification entry (stored in notifications collection) and link to this pre-order
                            try {
                                if (typeof addPreOrderNotification === 'function') {
                                    const customerName = `${firstName} ${lastName}`.trim();
                                    addPreOrderNotification(preOrder.frameName || 'Titanium Slim Frame', customerName, key);
                                }
                            } catch (err) {
                                console.warn('Notification creation failed:', err);
                            }

                            // Reset form
                            document.getElementById('preorderForm').reset();

                            // Redirect to confirmation page after a short delay
                            setTimeout(() => {
                                window.location.href = `preorder-confirmation.html?frameName=${encodeURIComponent(preOrder.frameName)}`;
                            }, 500);
                        })
                        .catch((error) => {
                            console.error('Error saving pre-order:', error);

                            if (formMessage) {
                                formMessage.textContent = 'Error submitting pre-order. Please try again.';
                                formMessage.className = 'form-message error';
                            }
                        });
                });
            }
        });
        
        // Load frame names from database
        async function loadFrameNames() {
            try {
                if (typeof getAllProducts === 'function') {
                    const products = await getAllProducts();
                    allFrameNames = products
                        .filter(product => product.visible && product.title) // Only visible products with titles
                        .map(product => product.title)
                        .sort(); // Sort alphabetically
                } else {
                    console.warn('getAllProducts function not available');
                }
            } catch (error) {
                console.error('Error loading frame names:', error);
            }
        }
        
        // Auto-fill frame name from URL parameter
        function autoFillFrameName() {
            const urlParams = new URLSearchParams(window.location.search);
            const frameName = urlParams.get('frameName');
            
            if (frameName) {
                const frameNameInput = document.getElementById('frameName');
                if (frameNameInput) {
                    frameNameInput.value = decodeURIComponent(frameName);
                    // Trigger input event to update any related functionality
                    frameNameInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
        }
        
        // Set up autocomplete functionality for frame name input
        function setupFrameNameAutocomplete() {
            const frameNameInput = document.getElementById('frameName');
            const dropdown = document.getElementById('frameNameDropdown');
            
            if (!frameNameInput || !dropdown) return;
            
            // Handle input events
            frameNameInput.addEventListener('input', function() {
                const query = this.value.trim();
                if (query.length > 0) {
                    showSuggestions(query);
                } else {
                    hideSuggestions();
                }
            });
            
            // Handle focus events
            frameNameInput.addEventListener('focus', function() {
                const query = this.value.trim();
                if (query.length > 0) {
                    showSuggestions(query);
                }
            });
            
            // Handle blur events (with delay to allow for clicks)
            frameNameInput.addEventListener('blur', function() {
                setTimeout(() => {
                    hideSuggestions();
                }, 150);
            });
            
            // Handle keyboard navigation
            frameNameInput.addEventListener('keydown', function(e) {
                if (!isDropdownVisible) return;
                
                const suggestions = dropdown.querySelectorAll('.autocomplete-item');
                const activeSuggestion = dropdown.querySelector('.autocomplete-item.active');
                let activeIndex = -1;
                
                if (activeSuggestion) {
                    activeIndex = Array.from(suggestions).indexOf(activeSuggestion);
                }
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        activeIndex = Math.min(activeIndex + 1, suggestions.length - 1);
                        updateActiveSuggestion(suggestions, activeIndex);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        activeIndex = Math.max(activeIndex - 1, -1);
                        updateActiveSuggestion(suggestions, activeIndex);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (activeSuggestion) {
                            selectSuggestion(activeSuggestion.textContent);
                        }
                        break;
                    case 'Escape':
                        hideSuggestions();
                        break;
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!frameNameInput.contains(e.target) && !dropdown.contains(e.target)) {
                    hideSuggestions();
                }
            });
        }
        
        // Show suggestions based on query
        function showSuggestions(query) {
            const dropdown = document.getElementById('frameNameDropdown');
            if (!dropdown) return;
            
            const filteredNames = allFrameNames.filter(name => 
                name.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filteredNames.length === 0) {
                hideSuggestions();
                return;
            }
            
            dropdown.innerHTML = filteredNames
                .slice(0, 10) // Limit to 10 suggestions
                .map(name => `
                    <div class="autocomplete-item" onclick="selectSuggestion('${escapeHtml(name)}')">
                        ${highlightMatch(name, query)}
                    </div>
                `).join('');
            
            dropdown.style.display = 'block';
            isDropdownVisible = true;
        }
        
        // Hide suggestions dropdown
        function hideSuggestions() {
            const dropdown = document.getElementById('frameNameDropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
                isDropdownVisible = false;
            }
        }
        
        // Select a suggestion
        function selectSuggestion(frameName) {
            const frameNameInput = document.getElementById('frameName');
            if (frameNameInput) {
                frameNameInput.value = frameName;
                hideSuggestions();
                frameNameInput.focus();
            }
        }
        
        // Update active suggestion for keyboard navigation
        function updateActiveSuggestion(suggestions, activeIndex) {
            suggestions.forEach((item, index) => {
                if (index === activeIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // Highlight matching text in suggestions
        function highlightMatch(text, query) {
            const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
            return text.replace(regex, '<strong>$1</strong>');
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Escape regex special characters
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // Using centralized firebaseServices.savePreOrderToFirebase; local duplicate removed
    </script>
</html>