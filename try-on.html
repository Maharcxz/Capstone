<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Virtual Try-On - Trinity Optimum Vision Center</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@300;400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/BaseStyles.css">
    <link rel="stylesheet" href="css/HeaderStyles.css">
    <link rel="stylesheet" href="css/TryOnStyles.css">
    
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <!-- Firebase Config and App Services -->
    <script src="JS/FirebaseConfig.js"></script>
    
    <!-- A-Frame and MindAR -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-face-aframe.prod.js"></script>
</head>
<body>
    <div class="virtual-try-on-container">
        <header class="try-on-header">
            <h1 class="try-on-title" onclick="navigateToHome()">Trinity Optimum Vision Center</h1>
        </header>
        
        <main class="try-on-main">
            <div class="camera-container">
                <!-- Loading overlay -->
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="loading-spinner"></div>
                    <p>Initializing AR Camera...</p>
                </div>
                
                <a-scene mindar-face embedded color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false" style="height: 100vh; width: 100vw;">
                     <a-assets>
                         <a-asset-item id="headOccluder" src="Assets/headOccluder.glb"></a-asset-item>
                     </a-assets>
                     
                     <a-camera 
                         id="camera"
                         position="0 0 0" 
                         look-controls="enabled: false" 
                         wasd-controls="enabled: false"
                         cursor="rayOrigin: mouse">
                     </a-camera>
                     
                     <!-- Head occluder for better AR effect -->
                     <a-entity mindar-face-target="anchorIndex: 168">
                         <a-gltf-model 
                             mindar-face-occluder 
                             position="0 -0.3 0.15"
                             rotation="0 0 0" 
                             scale="0.065 0.065 0.065" 
                             src="#headOccluder">
                         </a-gltf-model>
                     </a-entity>
                     
                     <!-- Dynamic Glasses Model (populated from products) -->
                     <a-entity mindar-face-target="anchorIndex: 168">
                         <a-entity 
                             id="glassesModelEntity"
                             rotation="0 0 0" 
                             position="0 0 0" 
                             scale="0.010 0.010 0.010" 
                             visible="false"
                             crossorigin="anonymous">
                         </a-entity>
                     </a-entity>
                 </a-scene>
                 
                 <!-- Controls Panel -->
                 <div class="controls-panel">
                 <div class="control-section">
                     <h3 class="control-title">Navigation</h3>
                     <a href="index.html" class="back-button-control">
                         ‚Üê Back to Products
                     </a>
                 </div>
                 
                 <div class="control-section">
                     <h3 class="control-title">Select Glasses</h3>
                     <div class="dropdown-container">
                         <button class="dropdown-btn" onclick="toggleDropdown()">
                             <span id="selected-glasses">3D Glasses</span>
                             <span class="dropdown-arrow">‚ñº</span>
                         </button>
                         <div class="dropdown-menu" id="glassesDropdown"></div>
                     </div>
                 </div>
                 
                 <div class="control-section">
                     <h3 class="control-title">Actions</h3>
                     <div class="action-buttons">
                         <button class="action-btn" onclick="capturePhoto()">
                             üì∏ Capture Photo
                         </button>
                         <button class="action-btn secondary" onclick="switchCamera()">
                             üîÑ Switch Camera
                         </button>
                     </div>
                 </div>
             </div>
         </div>
         </main>
         
         <!-- Status message -->
         <div class="status-message" id="statusMessage"></div>
     </div>
     
     <script>
         // Navigation function
         function navigateToHome() {
             window.location.href = 'index.html';
         }
         
         // Select glasses by GLB URL
         function selectGlasses(glbUrl, name) {
             // Update selected label
             document.getElementById('selected-glasses').textContent = name;
             
             // Mark selected item
             document.querySelectorAll('.dropdown-item').forEach(item => {
                 if (item.dataset && item.dataset.url === glbUrl) {
                     item.classList.add('selected');
                 } else {
                     item.classList.remove('selected');
                 }
             });
             
             // Set model entity src and show it
             const modelEntity = document.getElementById('glassesModelEntity');
             if (modelEntity) {
                 // Normalize before loading to avoid blob URLs
                 const normalized = (function(url){
                     if (!url || typeof url !== 'string') return url;
                     const gh = url.match(/^https?:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+)$/);
                     if (gh) {
                         const [, owner, repo, branch, path] = gh;
                         return `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`;
                     }
                     if (url.includes('dropbox.com') && url.includes('dl=0')) return url.replace('dl=0','dl=1');
                     const drive = url.match(/https?:\/\/drive\.google\.com\/file\/d\/([^\/]+)/);
                     if (drive) return `https://drive.google.com/uc?export=download&id=${drive[1]}`;
                     return url;
                 })(glbUrl);
                 // Use the gltf-model component for external URLs
                 modelEntity.setAttribute('gltf-model', normalized);
                 modelEntity.setAttribute('visible', true);
             }
             
             // Close dropdown
             document.getElementById('glassesDropdown').classList.remove('show');
         }
         
         // Toggle dropdown function
         function toggleDropdown() {
             const dropdown = document.getElementById('glassesDropdown');
             dropdown.classList.toggle('show');
         }
         
         // Close dropdown when clicking outside
         window.onclick = function(event) {
             if (!event.target.matches('.dropdown-btn') && !event.target.matches('.dropdown-arrow')) {
                 const dropdown = document.getElementById('glassesDropdown');
                 if (dropdown.classList.contains('show')) {
                     dropdown.classList.remove('show');
                 }
             }
         }
         
         // Capture photo function
         function capturePhoto() {
             // Implementation for photo capture
             console.log('Capturing photo...');
         }
         
         // Switch camera function
         function switchCamera() {
             // Implementation for camera switching
             console.log('Switching camera...');
         }
         
         // Status message function
         function showStatus(message, type = 'info') {
             const statusElement = document.getElementById('statusMessage');
             statusElement.textContent = message;
             statusElement.className = `status-message ${type}`;
             statusElement.style.display = 'block';
             
             setTimeout(() => {
                 statusElement.style.display = 'none';
             }, 3000);
         }
         
         // Populate dropdown from Firebase products
         async function loadTryOnProducts() {
             try {
                 if (typeof getAllProducts === 'function') {
                     const products = await getAllProducts();
                     populateDropdownFromProducts(products);
                 } else {
                     console.warn('Firebase product functions not available on try-on page');
                 }
                 
                 // Listen for real-time updates to auto-refresh dropdown
                 if (typeof listenForProductChanges === 'function') {
                     listenForProductChanges((products) => {
                         populateDropdownFromProducts(products);
                     });
                 }
             } catch (error) {
                 console.error('Error loading products for try-on:', error);
             }
         }
         
         function populateDropdownFromProducts(products) {
             const dropdown = document.getElementById('glassesDropdown');
             if (!dropdown) return;
            // Read query params for auto-selection
            const params = new URLSearchParams(window.location.search);
            const targetProductId = params.get('productId');
            const targetProductName = params.get('productName');

             // Only include visible products with at least one valid GLB URL
             const items = [];
             dropdown.innerHTML = '';
             products.forEach(product => {
                 if (!product.visible) return;
                 const firstGlb = Array.isArray(product.glbFiles) ? product.glbFiles[0] : null;
                 const glbUrl = firstGlb && typeof firstGlb.src === 'string' ? firstGlb.src : null;
                 if (!glbUrl || !glbUrl.toLowerCase().endsWith('.glb')) return;
                 
                 const btn = document.createElement('button');
                 btn.className = 'dropdown-item';
                 btn.textContent = product.title || 'Unnamed Product';
                 btn.dataset.url = glbUrl;
                  btn.dataset.productId = product.id || '';
                 btn.addEventListener('click', () => selectGlasses(glbUrl, btn.textContent));
                 dropdown.appendChild(btn);
                 items.push({ url: glbUrl, title: btn.textContent, id: product.id || '' });
             });
             
             // Auto-select matching item from query, otherwise first
             if (items.length > 0) {
                 let picked = null;
                 if (targetProductId) {
                     picked = items.find(i => i.id === targetProductId);
                 }
                 if (!picked && targetProductName) {
                     picked = items.find(i => i.title === targetProductName);
                 }
                 if (!picked) picked = items[0];
                 selectGlasses(picked.url, picked.title);
             } else {
                 // Hide model when no items
                 const modelEntity = document.getElementById('glassesModelEntity');
                 if (modelEntity) modelEntity.setAttribute('visible', false);
             }
         }
         
         // Initialize page
         document.addEventListener('DOMContentLoaded', function() {
             const loadingOverlay = document.getElementById('loadingOverlay');
             const modelEntity = document.getElementById('glassesModelEntity');
             
             // Model load status events for debugging and UX
             if (modelEntity) {
                 modelEntity.addEventListener('model-loaded', () => {
                     showStatus('Model loaded successfully', 'success');
                 });
                 modelEntity.addEventListener('model-error', (e) => {
                     console.error('A-Frame model load error:', e.detail);
                     showStatus('Failed to load model (check CORS/URL).', 'error');
                 });
             }
             loadTryOnProducts();
             // Simulate AR initialization complete
             setTimeout(() => {
                 if (loadingOverlay) loadingOverlay.style.display = 'none';
             }, 2000);
         });
     </script>
 </body>
 </html>