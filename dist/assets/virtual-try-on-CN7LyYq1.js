const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/main-v_mMUlmu.js","assets/HeaderStyles-BGGMSg_O.css"])))=>i.map(i=>d[i]);
/* empty css                     */(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();const B="modulepreload",H=function(n){return"/"+n},C={},O=function(e,t,s){let i=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),r=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));i=Promise.allSettled(t.map(c=>{if(c=H(c),c in C)return;C[c]=!0;const l=c.endsWith(".css"),h=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${h}`))return;const d=document.createElement("link");if(d.rel=l?"stylesheet":B,l||(d.as="script"),d.crossOrigin="",d.href=c,r&&d.setAttribute("nonce",r),document.head.appendChild(d),l)return new Promise((g,u)=>{d.addEventListener("load",g),d.addEventListener("error",()=>u(new Error(`Unable to preload CSS for ${c}`)))})}))}function a(o){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=o,window.dispatchEvent(r),!r.defaultPrevented)throw o}return i.then(o=>{for(const r of o||[])r.status==="rejected"&&a(r.reason);return e().catch(a)})};function P(){try{const n=document.createElement("canvas"),e=n.getContext("webgl2")||n.getContext("webgl")||n.getContext("experimental-webgl");if(!e)return console.warn("WebGL context creation failed"),!1;const t=e.getExtension("OES_texture_float")||e.getExtension("EXT_color_buffer_float"),s=e.getExtension("WEBGL_depth_texture"),i={supported:!0,version:e.getParameter(e.VERSION),vendor:e.getParameter(e.VENDOR),renderer:e.getParameter(e.RENDERER),hasFloatTextures:!!t,hasDepthTexture:!!s,maxTextureSize:e.getParameter(e.MAX_TEXTURE_SIZE),maxVertexAttribs:e.getParameter(e.MAX_VERTEX_ATTRIBS)};return console.log("‚úÖ WebGL Support Detected:",i),i}catch(n){return console.error("‚ùå WebGL check failed:",n),!1}}function V(){const n={isMobile:/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),isIOS:/iPad|iPhone|iPod/.test(navigator.userAgent),isAndroid:/Android/.test(navigator.userAgent),hasCamera:!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),hasWebGL:P(),memoryLimit:navigator.deviceMemory||"unknown",cores:navigator.hardwareConcurrency||"unknown",pixelRatio:window.devicePixelRatio||1};return console.log("Device capabilities:",n),n}const x=P();window.webglSupported=x&&x.supported?x:!1;window.deviceCapabilities=V();console.log("WebGL Support Check:",window.webglSupported);console.log("Device Capabilities:",window.deviceCapabilities);function q(){const n=window.deviceCapabilities;return n.isMobile?{antialias:n.pixelRatio<=1,shadowMap:!1,maxLights:2,pixelRatio:Math.min(n.pixelRatio,2),powerPreference:"low-power"}:{antialias:!0,shadowMap:!0,maxLights:4,pixelRatio:n.pixelRatio,powerPreference:"high-performance"}}window.threeJSConfig=q();async function D(){console.log("üöÄ Starting Virtual Try-On Application..."),console.log("WebGL Support Status:",window.webglSupported);try{console.log("üîÑ Attempting to load via Vite modules...");const{VirtualTryOnApp:n}=await O(async()=>{const{VirtualTryOnApp:t}=await import("./main-v_mMUlmu.js");return{VirtualTryOnApp:t}},__vite__mapDeps([0,1]));await new n().init(),console.log("‚úÖ Virtual Try-On Application initialized via Vite modules")}catch(n){console.error("‚ùå Failed to load via Vite modules:",n),console.warn("‚ö†Ô∏è Falling back to legacy loading method"),await W()}}function $(){const n=document.createElement("div");n.className="webgl-error",n.style.cssText=`
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #ff4444;
                color: white;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `,n.innerHTML=`
                <h3>WebGL Not Supported</h3>
                <p>Your browser doesn't support WebGL, which is required for 3D model rendering.</p>
                <p>Please try:</p>
                <ul style="text-align: left; margin: 10px 0;">
                    <li>Updating your browser</li>
                    <li>Enabling hardware acceleration</li>
                    <li>Using a different browser (Chrome, Firefox, Safari)</li>
                </ul>
            `,document.body.appendChild(n)}async function W(){if(console.log("üîÑ Loading fallback version..."),!window.webglSupported){console.error("‚ùå WebGL not supported in fallback mode"),$();return}if(!await N()){console.error("‚ùå Failed to load Three.js");return}const e=document.createElement("script");e.src="./JS/webxr-manager-legacy.js",e.onload=()=>{console.log("‚úÖ Legacy WebXRManager loaded");const t=document.createElement("script");t.src="./JS/virtual-try-on-legacy.js",t.onload=()=>{console.log("‚úÖ Legacy VirtualTryOn loaded"),typeof VirtualTryOn<"u"?(window.virtualTryOn=new VirtualTryOn,window.virtualTryOn.init().then(()=>{console.log("‚úÖ Legacy Virtual Try-On initialized"),typeof WebXRManager<"u"&&(window.webXRManager=new WebXRManager(window.virtualTryOn),console.log("‚úÖ Legacy WebXR Manager initialized"))}).catch(s=>{console.error("‚ùå Failed to initialize legacy Virtual Try-On:",s)})):console.error("‚ùå VirtualTryOn class not found")},t.onerror=()=>{console.error("‚ùå Failed to load virtual-try-on-legacy.js")},document.head.appendChild(t)},e.onerror=()=>{console.warn("‚ö†Ô∏è Failed to load webxr-manager-legacy.js, loading without WebXR");const t=document.createElement("script");t.src="./JS/virtual-try-on-legacy.js",t.onload=()=>{console.log("‚úÖ Legacy VirtualTryOn loaded (without WebXR)"),typeof VirtualTryOn<"u"&&(window.virtualTryOn=new VirtualTryOn,window.virtualTryOn.init().then(()=>{console.log("‚úÖ Legacy Virtual Try-On initialized (without WebXR)")}).catch(s=>{console.error("‚ùå Failed to initialize legacy Virtual Try-On:",s)}))},document.head.appendChild(t)},document.head.appendChild(e)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",D):D();async function N(){return new Promise(n=>{console.log("üì¶ Loading Three.js from CDN...");try{const e=document.createElement("script");e.src="https://unpkg.com/three@0.158.0/build/three.min.js",e.onload=()=>{console.log("‚úÖ Three.js core loaded"),typeof THREE<"u"?(THREE.GLTFLoader=function(){this.load=function(t,s,i,a){console.log("Loading GLB model:",t);const o=new THREE.Scene,r=new THREE.BoxGeometry(1,1,1),c=new THREE.MeshBasicMaterial({color:65280}),l=new THREE.Mesh(r,c);o.add(l),s&&setTimeout(()=>s({scene:o}),100)}},console.log("‚úÖ Three.js loaded with basic GLTFLoader"),window.threeJSLoaded=!0,n(!0)):(console.error("‚ùå Three.js still not available"),n(!1))},e.onerror=()=>{console.warn("‚ö†Ô∏è CDN loading failed"),n(!1)},document.head.appendChild(e),setTimeout(()=>{console.error("‚ùå Fallback loading timeout"),n(!1)},1e4)}catch(e){console.warn("‚ö†Ô∏è CDN loading failed:",e),n(!1)}})}let U=class{constructor(){this.video=null,this.canvas=null,this.ctx=null,this.faceMesh=null,this.scene=null,this.camera=null,this.renderer=null,this.glassesModel=null,this.currentFrame=null,this.faceDetected=!1,this.faceLandmarks=null,this.animationId=null,this.faceDetectionEnabled=!0,this.faceDetectionActive=!0,this.lastDetectionTime=0,this.detectionInterval=33,this.cameraPermissionGranted=!1,this.permissionCheckComplete=!1,this.adjustments={size:1,positionX:0,positionY:0,rotation:0},this.urlParams=new URLSearchParams(window.location.search),this.frameId=this.urlParams.get("frame"),this.productName=this.urlParams.get("productName"),this.frameToGLBMapping={"glasses-6":{id:"base",name:"Base Model",path:"Assets/base.glb"},"glasses-7":{id:"base_pbr",name:"Base PBR",path:"Assets/base_basic_pbr.glb"},"glasses-10":{id:"base_shaded",name:"Base Shaded",path:"Assets/base_basic_shaded.glb"},"glasses-11b":{id:"base",name:"Base Model",path:"Assets/base.glb"},"glasses-12":{id:"base_pbr",name:"Base PBR",path:"Assets/base_basic_pbr.glb"},"glasses-5b":{id:"base_shaded",name:"Base Shaded",path:"Assets/base_basic_shaded.glb"}},this.fallbackModels=["Assets/base.glb","Assets/base_basic_pbr.glb","Assets/base_basic_shaded.glb"],this.modelLoadAttempts=0,this.maxLoadAttempts=3,this.modelLoadTimeout=15e3,this.fallbackModelUsed=!1,this.webglSupported=!1,this.threeJSReady=!1,this.assignedGLBModel=this.frameId?this.frameToGLBMapping[this.frameId]:null,this.currentGLBModel=null,this.deviceCapabilities=window.deviceCapabilities||{},this.threeJSConfig=window.threeJSConfig||{},this.performanceMode=this.deviceCapabilities.isMobile?"low":"high",this.lastRenderTime=0,this.performanceStats=null,this.qualitySettings={low:{renderScale:.5,targetFPS:30,maxParticles:50,shadowMapSize:512,antialias:!1,precision:"lowp"},medium:{renderScale:.75,targetFPS:45,maxParticles:100,shadowMapSize:1024,antialias:!0,precision:"mediump"},high:{renderScale:1,targetFPS:60,maxParticles:200,shadowMapSize:2048,antialias:!0,precision:"highp"}},this.waitForDependencies().then(()=>this.init())}async waitForDependencies(){this.addBrowserPolyfills();const e=this.checkBrowserCompatibility();if(!e.supported){this.showBrowserCompatibilityError(e.issues);return}let t=0;const s=50;for(;t<s;){if(typeof window.webglSupported<"u"&&typeof window.threeJSLoaded<"u"){this.webglSupported=window.webglSupported&&window.webglSupported.supported!==!1,this.threeJSReady=window.threeJSLoaded;break}await new Promise(i=>setTimeout(i,100)),t++}t>=s&&(console.warn("Timeout waiting for dependencies, proceeding with limited functionality"),this.webglSupported=!1,this.threeJSReady=!1)}addBrowserPolyfills(){(!window.performance||!window.performance.now)&&(window.performance=window.performance||{},window.performance.now=function(){return Date.now()}),window.requestAnimationFrame||(window.requestAnimationFrame=function(e){return setTimeout(e,1e3/60)}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)}),navigator.mediaDevices||(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia||(navigator.mediaDevices.getUserMedia=function(e){const t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return t?new Promise((s,i)=>{t.call(navigator,e,s,i)}):Promise.reject(new Error("getUserMedia is not supported"))}),console.log("Browser polyfills added")}checkBrowserCompatibility(){const e=[];let t=!0;(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)&&(e.push("Camera access (getUserMedia) not supported"),t=!1),!window.WebGLRenderingContext&&!window.WebGL2RenderingContext&&(e.push("WebGL not supported"),t=!1),window.Worker||(e.push("Web Workers not supported"),console.warn("Web Workers not supported - some features may be slower"));const s=navigator.userAgent,i=this.getBrowserInfo(s);return i.name==="Internet Explorer"&&(e.push("Internet Explorer is not supported"),t=!1),i.name==="Chrome"&&i.version<60&&(e.push("Chrome version too old (minimum: 60)"),t=!1),i.name==="Firefox"&&i.version<55&&(e.push("Firefox version too old (minimum: 55)"),t=!1),i.name==="Safari"&&i.version<11&&(e.push("Safari version too old (minimum: 11)"),t=!1),{supported:t,issues:e,browserInfo:i}}getBrowserInfo(e){let t="Unknown",s=0;if(e.indexOf("Chrome")>-1){t="Chrome";const i=e.match(/Chrome\/(\d+)/);s=i?parseInt(i[1]):0}else if(e.indexOf("Firefox")>-1){t="Firefox";const i=e.match(/Firefox\/(\d+)/);s=i?parseInt(i[1]):0}else if(e.indexOf("Safari")>-1){t="Safari";const i=e.match(/Version\/(\d+)/);s=i?parseInt(i[1]):0}else if(e.indexOf("Edge")>-1){t="Edge";const i=e.match(/Edge\/(\d+)/);s=i?parseInt(i[1]):0}else(e.indexOf("MSIE")>-1||e.indexOf("Trident")>-1)&&(t="Internet Explorer");return{name:t,version:s}}showBrowserCompatibilityError(e){const t=document.createElement("div");t.className="browser-compatibility-error",t.innerHTML=`
            <div class="error-content">
                <h3>Browser Compatibility Issues</h3>
                <p>Your browser doesn't support some required features:</p>
                <ul>
                    ${e.map(s=>`<li>${s}</li>`).join("")}
                </ul>
                <p>Please try using a modern browser like:</p>
                <ul>
                    <li>Chrome 60+</li>
                    <li>Firefox 55+</li>
                    <li>Safari 11+</li>
                    <li>Edge 79+</li>
                </ul>
            </div>
        `,t.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            font-family: 'Poppins', sans-serif;
        `,t.querySelector(".error-content").style.cssText=`
            background: #1a1a1a;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            text-align: center;
        `,document.body.appendChild(t)}async init(){try{if(!this.webglSupported){this.showWebGLError();return}await this.setupCamera(),await this.setupFaceDetection(),this.threeJSReady?(this.setupThreeJS(),await this.loadAssignedGLBModelWithRetry()):this.show3DModelError("3D rendering unavailable - Three.js failed to load"),this.setupControls(),this.enhanceControls(),this.hideLoading(),this.faceDetectionEnabled||this.setDefaultGlassesPosition(),this.startDetection()}catch(e){console.error("Initialization error:",e),this.showError("Failed to initialize virtual try-on. Please check camera permissions and refresh the page.")}}showWebGLError(){const e=document.createElement("div");e.className="webgl-error",e.innerHTML=`
            <h3>WebGL Not Supported</h3>
            <p>Your browser doesn't support WebGL, which is required for 3D model rendering.</p>
            <p>Please try:</p>
            <ul style="text-align: left; margin: 10px 0;">
                <li>Updating your browser</li>
                <li>Enabling hardware acceleration</li>
                <li>Using a different browser (Chrome, Firefox, Safari)</li>
            </ul>
        `,document.body.appendChild(e)}async setupCamera(){if(this.video=document.getElementById("videoElement"),this.canvas=document.getElementById("canvasElement"),this.ctx=this.canvas.getContext("2d"),!(window.isSecureContext||location.hostname==="localhost"||location.hostname==="127.0.0.1"))throw new Error("Camera access requires HTTPS. Please use a secure connection or localhost.");if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera API not supported in this browser.");const t=await this.checkCameraPermission();if(console.log("Camera permission status:",t),t==="denied")throw this.showCameraPermissionHelp(),new Error("Camera access was previously denied. Please enable camera access in your browser settings.");return t==="granted"?await this.initializeCamera():await this.requestCameraAccess()}async checkCameraPermission(){try{if(navigator.permissions&&navigator.permissions.query){const s=await navigator.permissions.query({name:"camera"});return localStorage.setItem("cameraPermissionStatus",s.state),localStorage.setItem("cameraPermissionLastChecked",Date.now().toString()),s.addEventListener("change",()=>{localStorage.setItem("cameraPermissionStatus",s.state),console.log("Camera permission changed to:",s.state)}),s.state}}catch{console.log("Permission API not supported, checking localStorage")}const e=localStorage.getItem("cameraPermissionStatus"),t=localStorage.getItem("cameraPermissionLastChecked");if(e&&t){const s=Date.now()-parseInt(t),i=24*60*60*1e3;if(s<i&&e==="granted")return"granted"}return"prompt"}async requestCameraAccess(){try{console.log("Requesting camera access..."),this.showCameraPermissionRequest();const e=await this.attemptCameraAccess();return localStorage.setItem("cameraPermissionStatus","granted"),localStorage.setItem("cameraPermissionLastChecked",Date.now().toString()),this.cameraPermissionGranted=!0,this.hideCameraPermissionRequest(),await this.setupVideoStream(e)}catch(e){throw this.hideCameraPermissionRequest(),e.name==="NotAllowedError"?(localStorage.setItem("cameraPermissionStatus","denied"),localStorage.setItem("cameraPermissionLastChecked",Date.now().toString()),this.showCameraPermissionHelp(),new Error("Camera access was denied. Please allow camera access to use the virtual try-on feature.")):e}}async initializeCamera(){try{console.log("Initializing camera with existing permission...");const e=await this.attemptCameraAccess();return this.cameraPermissionGranted=!0,await this.setupVideoStream(e)}catch(e){throw e.name==="NotAllowedError"&&(localStorage.setItem("cameraPermissionStatus","denied"),this.showCameraPermissionHelp()),e}}async attemptCameraAccess(){const e={video:{width:{ideal:1280,min:640},height:{ideal:720,min:480},facingMode:"user"},audio:!1};try{return await navigator.mediaDevices.getUserMedia(e)}catch(t){if(t.name==="OverconstrainedError"){console.log("Trying with basic camera constraints...");const s={video:{facingMode:"user"},audio:!1};return await navigator.mediaDevices.getUserMedia(s)}throw t}}async setupVideoStream(e){return this.video.srcObject=e,new Promise((t,s)=>{const i=setTimeout(()=>{s(new Error("Video loading timeout"))},1e4);this.video.onloadedmetadata=()=>{clearTimeout(i),this.video.play().then(()=>{this.resizeCanvas(),console.log("Camera initialized successfully"),t()}).catch(s)},this.video.onerror=a=>{clearTimeout(i),s(new Error("Video element error: "+a.message))}})}showCameraPermissionRequest(){if(document.getElementById("cameraPermissionRequest"))return;const t=document.createElement("div");t.id="cameraPermissionRequest",t.style.cssText=`
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 10000;
            max-width: 400px;
        `,t.innerHTML=`
            <h3>Camera Access Required</h3>
            <p>Please allow camera access to use the virtual try-on feature.</p>
            <p>Your browser will ask for permission - please click "Allow".</p>
        `,document.body.appendChild(t)}hideCameraPermissionRequest(){const e=document.getElementById("cameraPermissionRequest");e&&e.remove()}showCameraPermissionHelp(){if(document.getElementById("cameraPermissionHelp"))return;const t=document.createElement("div");t.id="cameraPermissionHelp",t.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 8px;
            max-width: 300px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;const s=/Chrome/.test(navigator.userAgent),i=/Firefox/.test(navigator.userAgent);let a="";s?a='Click the camera icon in the address bar, then select "Always allow" and refresh the page.':i?a="Click the shield icon in the address bar, then enable camera access and refresh the page.":a="Enable camera access in your browser settings and refresh the page.",t.innerHTML=`
            <h4>Camera Access Needed</h4>
            <p>${a}</p>
            <button onclick="this.parentElement.remove()" style="
                background: white;
                color: #ff6b6b;
                border: none;
                padding: 5px 10px;
                border-radius: 4px;
                cursor: pointer;
                margin-top: 10px;
            ">Got it</button>
        `,document.body.appendChild(t),setTimeout(()=>{t.parentElement&&t.remove()},1e4)}async setupFaceDetection(){try{if(typeof FaceMesh>"u"){console.warn("MediaPipe FaceMesh not available, using fallback positioning"),this.faceMesh=null,this.faceDetectionEnabled=!1,this.showFaceDetectionStatus("Face detection unavailable - using manual positioning");return}this.showFaceDetectionStatus("Initializing face detection..."),this.faceMesh=new FaceMesh({locateFile:e=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${e}`}),this.faceMesh.setOptions({maxNumFaces:1,refineLandmarks:!0,minDetectionConfidence:.7,minTrackingConfidence:.5,staticImageMode:!1}),this.faceMesh.onResults(e=>{this.onFaceDetectionResults(e)}),await this.testFaceDetection(),this.faceDetectionEnabled=!0,this.showFaceDetectionStatus("Face detection active"),console.log("Face detection initialized successfully")}catch(e){console.warn("Face detection setup failed:",e),this.faceMesh=null,this.faceDetectionEnabled=!1,this.showFaceDetectionStatus("Face detection failed - using manual positioning")}}async testFaceDetection(){return new Promise((e,t)=>{const s=setTimeout(()=>{t(new Error("Face detection test timeout"))},5e3),i=a=>{clearTimeout(s),this.faceMesh.onResults(this.onFaceDetectionResults.bind(this)),e()};this.faceMesh.onResults(i),this.video&&this.video.readyState>=2?this.faceMesh.send({image:this.video}).catch(t):(clearTimeout(s),e())})}showFaceDetectionStatus(e){let t=document.getElementById("faceDetectionStatus");if(!t){t=document.createElement("div"),t.id="faceDetectionStatus",t.style.cssText=`
                position: absolute;
                top: 10px;
                left: 10px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 12px;
                font-family: 'Poppins', sans-serif;
                z-index: 1000;
                transition: opacity 0.3s ease;
            `;const s=document.querySelector(".camera-container");s&&s.appendChild(t)}t.textContent=e,t.style.opacity="1",e.includes("active")&&setTimeout(()=>{t.style.opacity="0.7"},3e3)}setupThreeJS(){try{if(typeof THREE>"u"){console.warn("Three.js not available, 3D rendering will be disabled");return}const e=this.qualitySettings[this.performanceMode];console.log(`Setting up Three.js with ${this.performanceMode} quality mode:`,e),this.scene=new THREE.Scene;const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height;const s=this.deviceCapabilities.isMobile?70:75;this.camera=new THREE.PerspectiveCamera(s,this.canvas.width/this.canvas.height,.1,1e3),this.camera.position.set(0,0,5);const i={canvas:this.canvas,alpha:!0,antialias:e.antialias,precision:e.precision,powerPreference:this.deviceCapabilities.isMobile?"low-power":"high-performance",preserveDrawingBuffer:!0};this.threeJSConfig.contextType&&(i.context=this.threeJSConfig.contextType),this.renderer=new THREE.WebGLRenderer(i),this.renderer.setSize(this.canvas.width,this.canvas.height,!1),this.renderer.setClearColor(0,0),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),e.shadowMapSize>0&&!this.deviceCapabilities.isMobile&&(this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,this.renderer.shadowMap.setSize(e.shadowMapSize,e.shadowMapSize));const a=this.deviceCapabilities.isMobile?.4:.3;this.ambientLight=new THREE.AmbientLight(16777215,a),this.scene.add(this.ambientLight),this.mainLight=new THREE.DirectionalLight(16777215,.6),this.mainLight.position.set(0,1,.5),this.scene.add(this.mainLight),this.fillLight=new THREE.DirectionalLight(16777215,.3),this.fillLight.position.set(-.5,.5,1),this.scene.add(this.fillLight),this.rimLight=new THREE.DirectionalLight(16777215,.2),this.rimLight.position.set(0,-.5,-1),this.scene.add(this.rimLight),e.shadowMapSize>0&&!this.deviceCapabilities.isMobile&&(this.mainLight.castShadow=!0,this.mainLight.shadow.mapSize.width=e.shadowMapSize,this.mainLight.shadow.mapSize.height=e.shadowMapSize,this.mainLight.shadow.camera.near=.1,this.mainLight.shadow.camera.far=10,this.mainLight.shadow.camera.left=-2,this.mainLight.shadow.camera.right=2,this.mainLight.shadow.camera.top=2,this.mainLight.shadow.camera.bottom=-2,this.mainLight.shadow.bias=-1e-4),this.setupEnvironmentMapping(),this.addDebugHelpers(),console.log(`Three.js initialized successfully with ${this.performanceMode} quality settings`),console.log("Render size:",this.canvas.width,"x",this.canvas.height),console.log("Device capabilities:",this.deviceCapabilities)}catch(e){console.warn("Three.js setup failed:",e)}}setupControls(){document.getElementById("captureBtn").addEventListener("click",()=>{this.capturePhoto()}),document.getElementById("switchCameraBtn").addEventListener("click",()=>{this.switchCamera()})}setupEnvironmentMapping(){try{const e=new THREE.PMREMGenerator(this.renderer),t=this.deviceCapabilities.isMobile?64:128,s=new THREE.DataTexture(new Uint8Array(t*t*4),t,t,THREE.RGBAFormat),i=s.image.data;for(let a=0;a<i.length;a+=4){const o=Math.floor(a/4/t)/t,r=Math.max(.2,1-o);i[a]=r*255,i[a+1]=r*255,i[a+2]=r*255,i[a+3]=255}s.needsUpdate=!0,this.envMap=e.fromEquirectangular(s).texture,this.scene.environment=this.envMap,e.dispose(),console.log("Environment mapping setup complete")}catch(e){console.warn("Environment mapping setup failed:",e)}}updateDynamicLighting(){if(!this.faceLandmarks||!this.mainLight||!this.fillLight)return;const e=this.calculateFaceAngle(),t=this.calculateHeadPitch(),s=.3;this.mainLight.position.x=Math.sin(e)*s,this.mainLight.position.y=1+Math.sin(t)*s,this.mainLight.position.z=.5+Math.cos(e)*s,this.fillLight.position.x=-this.mainLight.position.x*.5,this.fillLight.position.y=this.mainLight.position.y*.8;const i=Math.cos(e)*Math.cos(t),a=Math.max(.2,Math.min(.5,.3+i*.2));this.ambientLight.intensity=a}addDebugHelpers(){const e=new THREE.BoxGeometry(.5,.5,.5),t=new THREE.MeshBasicMaterial({color:65280,wireframe:!0,transparent:!0,opacity:.3});this.debugCube=new THREE.Mesh(e,t),this.debugCube.position.set(1,1,0),this.scene.add(this.debugCube);const s=new THREE.AxesHelper(1);this.scene.add(s),console.log("Debug helpers added: wireframe cube and axes")}async loadAssignedGLBModelWithRetry(){if(console.log("üîç Loading assigned GLB model with retry mechanism..."),console.log("üîç Frame ID:",this.frameId),console.log("üîç Product Name:",this.productName),console.log("üîç Assigned GLB Model:",this.assignedGLBModel),this.productName&&this.updateHeaderTitle(`Virtual Try-On - ${this.productName}`),!this.assignedGLBModel){const e=this.frameId?`‚ùå No GLB model found for frame: ${this.frameId}`:"‚ö†Ô∏è No frame specified in URL parameters";console.warn(e),await this.loadFallbackModel();return}for(let e=1;e<=this.maxLoadAttempts;e++)try{if(this.modelLoadAttempts=e,this.show3DModelLoading(`Loading 3D model (attempt ${e}/${this.maxLoadAttempts})...`),await this.loadGlassesModel(this.assignedGLBModel.path)){this.currentGLBModel=this.assignedGLBModel,this.showModelControls(),this.show3DModelSuccess(`‚úÖ Loaded ${this.assignedGLBModel.name} for ${this.productName||"product"}`);return}}catch(t){if(console.error(`Model loading attempt ${e} failed:`,t),e===this.maxLoadAttempts){console.log("All attempts failed, trying fallback models..."),await this.loadFallbackModel();return}await new Promise(s=>setTimeout(s,1e3*e))}}async loadFallbackModel(){console.log("Loading fallback model..."),this.fallbackModelUsed=!0;for(const e of this.fallbackModels)try{if(this.show3DModelLoading("Loading fallback 3D model..."),await this.loadGlassesModel(e)){this.showFallbackNotice(),this.showModelControls();return}}catch(t){console.error("Fallback model failed:",e,t)}this.showModelLoadError()}showFallbackNotice(){const e=document.createElement("div");e.className="fallback-model",e.innerHTML="‚ö†Ô∏è Using fallback 3D model - original model unavailable",document.querySelector(".controls-panel").prepend(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},5e3)}showModelLoadError(){const e=document.createElement("div");e.className="model-error-overlay",e.innerHTML=`
            <h3>3D Model Loading Failed</h3>
            <p>Unable to load the 3D glasses model.</p>
            <p>This might be due to:</p>
            <ul style="text-align: left; margin: 10px 0;">
                <li>Network connectivity issues</li>
                <li>Server problems</li>
                <li>Browser compatibility</li>
            </ul>
            <button class="retry-button" onclick="virtualTryOn.retryModelLoading()">Retry Loading</button>
            <button class="retry-button" onclick="virtualTryOn.hideModelError()" style="background: #666; margin-left: 10px;">Continue Without 3D</button>
        `,document.querySelector(".camera-container").appendChild(e)}hideModelError(){const e=document.querySelector(".model-error-overlay");e&&e.remove()}async retryModelLoading(){this.hideModelError(),this.modelLoadAttempts=0,await this.loadAssignedGLBModelWithRetry()}showModelControls(){const e=document.getElementById("modelControls");e&&(e.style.display="block")}hideModelControls(){const e=document.getElementById("modelControls");e&&(e.style.display="none")}updateModelScale(e){if(this.glassesModel){const t=parseFloat(e);this.glassesModel.scale.set(t*.1,t*.1,t*.1),console.log("Model scale updated to:",t)}}updateModelPositionY(e){if(this.glassesModel){const t=parseFloat(e);this.glassesModel.position.y=t,console.log("Model position Y updated to:",t)}}updateModelRotationY(e){if(this.glassesModel){const t=parseFloat(e)*(Math.PI/180);this.glassesModel.rotation.y=t,console.log("Model rotation Y updated to:",e,"degrees")}}resetModelTransform(){this.glassesModel&&(this.glassesModel.scale.set(.1,.1,.1),this.glassesModel.position.set(0,.2,0),this.glassesModel.rotation.set(0,0,0),document.getElementById("modelScale").value=1,document.getElementById("modelPositionY").value=0,document.getElementById("modelRotationY").value=0,console.log("Model transform reset to defaults"))}async loadGlassesModel(e){if(console.log("üîÑ Loading glasses model with modern implementation:",e),!this.validateThreeJSEnvironment())return!1;try{this.glassesModel&&(console.log("üóëÔ∏è Removing existing glasses model"),this.scene.remove(this.glassesModel),this.glassesModel=null),this.show3DModelLoading();const t=await this.loadGLTFWithRetry(e,3);return await this.processLoadedGLTF(t,e),console.log("üéâ Glasses model loading completed successfully!"),!0}catch(t){return console.error("‚ùå Critical error loading glasses model:",t),this.handleGLTFLoadingError(t,e),!1}}validateThreeJSEnvironment(){return typeof THREE>"u"?(console.error("‚ùå THREE.js not available"),this.show3DModelError("3D model viewer not available - THREE.js missing"),!1):typeof THREE.GLTFLoader>"u"?(console.error("‚ùå GLTFLoader not available"),console.log("Available THREE properties:",Object.keys(THREE)),this.show3DModelError("3D model viewer not available - GLTFLoader missing"),!1):!this.scene||!this.camera||!this.renderer?(console.error("‚ùå Three.js scene not properly initialized:",{scene:!!this.scene,camera:!!this.camera,renderer:!!this.renderer}),this.show3DModelError("3D scene not initialized"),!1):(console.log("‚úÖ Three.js environment validation passed"),!0)}async loadGLTFWithRetry(e,t=3){let s;for(let i=1;i<=t;i++)try{console.log(`üîÑ GLTF loading attempt ${i}/${t}`);const a=new THREE.GLTFLoader;return await new Promise((r,c)=>{const l=setTimeout(()=>{c(new Error(`Loading timeout after 30 seconds (attempt ${i})`))},3e4);a.load(e,h=>{clearTimeout(l),console.log(`‚úÖ GLTF loaded successfully on attempt ${i}:`,h),r(h)},h=>{if(h.total>0){const d=(h.loaded/h.total*100).toFixed(1);console.log(`üìä Loading progress (attempt ${i}): ${d}%`),this.update3DModelLoadingProgress(Math.round(d))}},h=>{clearTimeout(l),console.error(`‚ùå GLTF loading error on attempt ${i}:`,h),c(h)})})}catch(a){if(s=a,console.warn(`‚ö†Ô∏è Attempt ${i} failed:`,a.message),i<t){const o=i*1e3;console.log(`‚è≥ Retrying in ${o}ms...`),await new Promise(r=>setTimeout(r,o))}}throw new Error(`Failed to load GLTF after ${t} attempts. Last error: ${s.message}`)}async processLoadedGLTF(e,t){var a,o,r,c;if(console.log("üîß Processing loaded GLTF..."),!e||!e.scene)throw new Error("Invalid GLTF structure - no scene found");this.glassesModel=e.scene,console.log("Model structure analysis:",{scene:this.glassesModel,children:this.glassesModel.children.length,animations:((a=e.animations)==null?void 0:a.length)||0,cameras:((o=e.cameras)==null?void 0:o.length)||0,scenes:((r=e.scenes)==null?void 0:r.length)||0});let s=0,i=!1;if(this.glassesModel.traverse(l=>{l.isMesh&&l.geometry&&(i=!0,s++)}),!i)throw new Error("3D model contains no valid geometry");console.log(`‚úÖ Found ${s} meshes with valid geometry`),this.glassesModel.scale.set(1,1,1),this.glassesModel.position.set(0,0,0),this.glassesModel.rotation.set(0,0,0),this.glassesModel.visible=!0,this.glassesModel.traverse(l=>{var h,d;l.isMesh&&(console.log("üîß Configuring mesh:",{name:l.name||"unnamed",geometry:(h=l.geometry)==null?void 0:h.type,material:(d=l.material)==null?void 0:d.type,visible:l.visible}),l.visible=!0,l.castShadow=!0,l.receiveShadow=!0,l.frustumCulled=!1,this.configureMeshMaterial(l))}),this.scene.add(this.glassesModel),console.log("‚úÖ Glasses model added to scene"),console.log("Scene children count:",this.scene.children.length),this.currentModelPath=t,this.updateGlassesTransform(),this.hide3DModelMessage(),this.show3DModelSuccess("3D model loaded successfully"),this.render3D(),console.log("Final scene state:",{children:this.scene.children.length,glassesModel:!!this.glassesModel,modelVisible:(c=this.glassesModel)==null?void 0:c.visible})}configureMeshMaterial(e){if(!e.material)return;(Array.isArray(e.material)?e.material:[e.material]).forEach((s,i)=>{console.log(`üé® Configuring material ${i}:`,s.type),s.transparent=!0,s.opacity=1,s.side=THREE.DoubleSide,s.alphaTest=.1,s.depthWrite=!0,s.depthTest=!0,s.needsUpdate=!0})}handleGLTFLoadingError(e,t){console.error("‚ùå GLTF loading error details:",{message:e.message,stack:e.stack,modelPath:t,threeJSAvailable:typeof THREE<"u",gltfLoaderAvailable:typeof(THREE==null?void 0:THREE.GLTFLoader)<"u",sceneInitialized:!!this.scene}),this.hide3DModelMessage();let s="Failed to load 3D model";e.message.includes("404")||e.message.includes("not found")?s="3D model file not found":e.message.includes("timeout")?s="3D model loading timeout":e.message.includes("network")?s="Network error loading 3D model":e.message.includes("parse")||e.message.includes("Invalid")?s="3D model file is corrupted or invalid":e.message.includes("CORS")&&(s="3D model access blocked by security policy"),this.show3DModelError(s),this.glassesModel&&(this.scene.remove(this.glassesModel),this.glassesModel=null)}updateHeaderTitle(e){const t=document.getElementById("tryOnTitle");t&&(e?t.textContent=`Virtual Try-On ‚Äì ${e}`:t.textContent="Virtual Try-On")}onFaceDetectionResults(e){if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),e.multiFaceLandmarks&&e.multiFaceLandmarks.length>0){const t=e.multiFaceLandmarks[0];this.validateLandmarks(t)?(this.faceDetected=!0,this.faceLandmarks=this.smoothLandmarks(t),this.updateGlassesPosition(),this.updateFaceDetectionIndicator(!0)):(this.faceLandmarks||(this.faceDetected=!1,this.glassesModel&&(this.glassesModel.visible=!1)),this.updateFaceDetectionIndicator(!1))}else this.faceDetected=!1,this.glassesModel&&(this.glassesModel.visible=!1),this.updateFaceDetectionIndicator(!1);this.render3D()}validateLandmarks(e){if(!e||e.length<468)return!1;const t=e[33],s=e[263],i=e[168];if(!(t&&s&&i&&t.x>=0&&t.x<=1&&t.y>=0&&t.y<=1&&s.x>=0&&s.x<=1&&s.y>=0&&s.y<=1))return!1;const o=Math.sqrt(Math.pow(s.x-t.x,2)+Math.pow(s.y-t.y,2));return o>.05&&o<.5}smoothLandmarks(e){if(!this.faceLandmarks)return e;const t=.7,s=[];for(let i=0;i<e.length;i++){const a=this.faceLandmarks[i],o=e[i];a&&o?s[i]={x:a.x*t+o.x*(1-t),y:a.y*t+o.y*(1-t),z:a.z*t+o.z*(1-t)}:s[i]=o}return s}updateFaceDetectionIndicator(e){const t=document.getElementById("faceDetectionStatus");t&&this.faceDetectionEnabled&&(e?(t.style.background="rgba(76, 175, 80, 0.8)",t.textContent="Face detected"):(t.style.background="rgba(255, 152, 0, 0.8)",t.textContent="Looking for face..."))}updateGlassesPosition(){if(!this.glassesModel||!this.faceLandmarks)return;const e=this.faceLandmarks[33],t=this.faceLandmarks[133],s=this.faceLandmarks[263],i=this.faceLandmarks[362],a=this.faceLandmarks[168];this.faceLandmarks[6];const o=this.faceLandmarks[9],r=this.faceLandmarks[175],c={x:(e.x+t.x)/2,y:(e.y+t.y)/2,z:(e.z+t.z)/2},l={x:(s.x+i.x)/2,y:(s.y+i.y)/2,z:(s.z+i.z)/2},h=Math.abs(o.y-r.y),d=Math.abs(s.x-e.x),g=Math.abs(a.z-o.z),u=d*this.canvas.width,p=Math.max(.3,Math.min(3,150/u)),f={x:(c.x+l.x)/2,y:(c.y+l.y)/2-h*.05,z:(c.z+l.z)/2+g*.1},k=f.x*2-1,F=-(f.y*2-1),R=f.z*p,y=this.currentGLBModel!==null,L=y?1.8:1.5,z=y?-.15:-.1,m=.15,w={x:k*L,y:F*L,z:R+z};this.glassesModel.position.x+=(w.x-this.glassesModel.position.x)*m,this.glassesModel.position.y+=(w.y-this.glassesModel.position.y)*m,this.glassesModel.position.z+=(w.z-this.glassesModel.position.z)*m;let M;y?M=Math.max(.08,Math.min(.25,d*1.8*p)):M=Math.max(.2,Math.min(1.5,d*2.5*p));const I=M,E=this.glassesModel.scale.x,b=E+(I-E)*m;this.glassesModel.scale.set(b,b,b);const G=Math.atan2(l.y-c.y,l.x-c.x),A=this.calculateHeadTilt(),S=this.calculateFaceAngle(),T=this.calculateHeadPitch(),v={x:T*.4,y:S*.5,z:G+A*.3};this.glassesModel.rotation.x+=(v.x-this.glassesModel.rotation.x)*m,this.glassesModel.rotation.y+=(v.y-this.glassesModel.rotation.y)*m,this.glassesModel.rotation.z+=(v.z-this.glassesModel.rotation.z)*m,this.updateGlassesLighting(S,T),this.applyGlassesPhysics(),this.glassesModel.visible=!0,this.updateGlassesTransform()}calculateHeadTilt(){if(!this.faceLandmarks)return 0;const e=this.faceLandmarks[21],t=this.faceLandmarks[251];return e&&t?Math.atan2(t.y-e.y,t.x-e.x)*.2:0}calculateFaceAngle(){if(!this.faceLandmarks)return 0;const e=this.faceLandmarks[1],t=this.faceLandmarks[234],s=this.faceLandmarks[454];if(e&&t&&s){const i=Math.abs(e.x-t.x),a=Math.abs(e.x-s.x),o=(a-i)/(a+i);return Math.max(-.5,Math.min(.5,o*2))}return 0}calculateHeadPitch(){if(!this.faceLandmarks)return 0;const e=this.faceLandmarks[9],t=this.faceLandmarks[175],s=this.faceLandmarks[168];if(e&&t&&s){const i={y:t.y-e.y,z:t.z-e.z};return Math.atan2(i.z,i.y)*.3}return 0}updateGlassesLighting(e,t){this.glassesModel&&this.glassesModel.traverse(s=>{if(s.isMesh&&s.material){const i=Math.cos(e)*Math.cos(t),a=Math.max(.3,Math.min(1,i+.5));s.userData.originalMaterial||(s.userData.originalMaterial={color:s.material.color?s.material.color.clone():null,metalness:s.material.metalness||0,roughness:s.material.roughness||.5}),s.material.color&&s.userData.originalMaterial.color&&(s.material.color.copy(s.userData.originalMaterial.color),s.material.color.multiplyScalar(a)),s.material.metalness!==void 0&&(s.material.metalness=Math.max(.1,Math.min(.8,s.userData.originalMaterial.metalness+a*.3))),s.material.roughness!==void 0&&(s.material.roughness=Math.max(.2,Math.min(.9,s.userData.originalMaterial.roughness+(1-a)*.3)))}})}applyGlassesPhysics(){if(!this.glassesModel||!this.faceLandmarks)return;this.glassesPhysics||(this.glassesPhysics={velocity:{x:0,y:0,z:0},lastPosition:{x:this.glassesModel.position.x,y:this.glassesModel.position.y,z:this.glassesModel.position.z},damping:.85,springStrength:.1});const e=this.glassesModel.position.x-this.glassesPhysics.lastPosition.x,t=this.glassesModel.position.y-this.glassesPhysics.lastPosition.y,s=this.glassesModel.position.z-this.glassesPhysics.lastPosition.z;this.glassesPhysics.velocity.x=(this.glassesPhysics.velocity.x+e)*this.glassesPhysics.damping,this.glassesPhysics.velocity.y=(this.glassesPhysics.velocity.y+t)*this.glassesPhysics.damping,this.glassesPhysics.velocity.z=(this.glassesPhysics.velocity.z+s)*this.glassesPhysics.damping;const i=.02;this.glassesModel.position.x+=this.glassesPhysics.velocity.x*i,this.glassesModel.position.y+=this.glassesPhysics.velocity.y*i,this.glassesModel.position.z+=this.glassesPhysics.velocity.z*i,this.glassesPhysics.lastPosition.x=this.glassesModel.position.x,this.glassesPhysics.lastPosition.y=this.glassesModel.position.y,this.glassesPhysics.lastPosition.z=this.glassesModel.position.z;const a=Date.now()*.001,o=Math.sin(a*.5)*.002;this.glassesModel.position.y+=o}updateGlassesTransform(){if(!this.glassesModel)return;const e=this.glassesModel.scale.x,t=this.glassesModel.position.x,s=this.glassesModel.position.y,i=this.glassesModel.rotation.z,a=e*this.adjustments.size;this.glassesModel.scale.set(a,a,a),this.glassesModel.position.x=t+this.adjustments.positionX*.01,this.glassesModel.position.y=s+this.adjustments.positionY*.01,this.glassesModel.rotation.z=i+this.adjustments.rotation*Math.PI/180}setDefaultGlassesPosition(){this.glassesModel&&(this.glassesModel.position.set(0,.2,0),this.glassesModel.scale.set(1,1,1),this.glassesModel.rotation.set(0,0,0),this.glassesModel.visible=!0,this.updateGlassesTransform(),this.showManualControlsHint())}showManualControlsHint(){const e=document.createElement("div");e.id="manualControlsHint",e.style.cssText=`
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 193, 7, 0.9);
            color: black;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 13px;
            font-family: 'Poppins', sans-serif;
            z-index: 1000;
            max-width: 250px;
            line-height: 1.4;
        `,e.innerHTML=`
            <strong>Manual Mode</strong><br>
            Use the controls on the right to adjust glasses position, size, and rotation.
        `;const t=document.querySelector(".camera-container");if(t){const s=document.getElementById("manualControlsHint");s&&s.remove(),t.appendChild(e),setTimeout(()=>{e.parentNode&&(e.style.opacity="0",setTimeout(()=>e.remove(),300))},5e3)}}enhanceControls(){const e=document.querySelector(".controls-panel");if(e&&this.faceDetectionEnabled){const t=document.createElement("div");t.className="control-section",t.innerHTML=`
                <div class="control-title">Face Detection</div>
                <label style="display: flex; align-items: center; color: white; cursor: pointer;">
                    <input type="checkbox" id="faceDetectionToggle" checked style="margin-right: 8px;">
                    Auto-position glasses
                </label>
                <small style="color: rgba(255,255,255,0.7); font-size: 11px; margin-top: 5px; display: block;">
                    Uncheck to use manual controls only
                </small>
            `;const s=e.querySelector(".control-section");s?s.parentNode.insertBefore(t,s.nextSibling):e.appendChild(t);const i=document.getElementById("faceDetectionToggle");i&&i.addEventListener("change",a=>{this.faceDetectionActive=a.target.checked,this.faceDetectionActive||this.setDefaultGlassesPosition()})}}render3D(){if(!this.renderer||!this.scene||!this.camera)return;const e=performance.now();this.lastRenderTime||(this.lastRenderTime=e);const t=e-this.lastRenderTime,i=1e3/(this.performanceMode==="high"?60:30);t<i||(this.lastRenderTime=e,this.debugCube&&(this.debugCube.rotation.x+=.01,this.debugCube.rotation.y+=.01),this.glassesModel&&(this.glassesModel.visible||(this.glassesModel.visible=!0),this.updateDynamicLighting(),this.glassesModel.frustumCulled=!0),this.renderer.render(this.scene,this.camera),this.updatePerformanceStats(t))}updatePerformanceStats(e){this.performanceStats||(this.performanceStats={frameCount:0,totalTime:0,avgFPS:0,lastUpdate:performance.now()}),this.performanceStats.frameCount++,this.performanceStats.totalTime+=e;const t=performance.now();t-this.performanceStats.lastUpdate>1e3&&(this.performanceStats.avgFPS=Math.round(1e3/(this.performanceStats.totalTime/this.performanceStats.frameCount)),this.performanceStats.avgFPS<20&&this.performanceMode!=="low"?(this.performanceMode="low",console.log("Switching to low performance mode for better frame rate")):this.performanceStats.avgFPS>45&&this.performanceMode!=="high"&&(this.performanceMode="high"),this.performanceStats.frameCount=0,this.performanceStats.totalTime=0,this.performanceStats.lastUpdate=t)}show3DModelLoading(){this.hide3DModelMessage();const e=this.get3DModelMessageContainer();e.innerHTML=`
            <div class="model-loading">
                <div class="loading-spinner"></div>
                <span>Loading 3D model...</span>
                <div class="loading-progress">
                    <div class="progress-bar" id="model-progress-bar"></div>
                </div>
            </div>
        `,e.style.display="block"}update3DModelLoadingProgress(e){const t=document.getElementById("model-progress-bar");t&&(t.style.width=e+"%");const s=document.querySelector(".model-loading span");s&&(s.textContent=`Loading 3D model... ${e}%`)}show3DModelError(e){this.hide3DModelMessage();const t=this.get3DModelMessageContainer();t.innerHTML=`
            <div class="model-error">
                <div class="error-icon">‚ö†Ô∏è</div>
                <span>${e}</span>
                <button class="retry-btn" onclick="virtualTryOn.retryModelLoading()">Retry</button>
            </div>
        `,t.style.display="block",setTimeout(()=>{this.hide3DModelMessage()},8e3)}show3DModelSuccess(e){this.hide3DModelMessage();const t=this.get3DModelMessageContainer();t.innerHTML=`
            <div class="model-success">
                <div class="success-icon">‚úÖ</div>
                <span>${e}</span>
            </div>
        `,t.style.display="block",setTimeout(()=>{this.hide3DModelMessage()},3e3)}hide3DModelMessage(){const e=this.get3DModelMessageContainer();e.style.display="none",e.innerHTML=""}get3DModelMessageContainer(){let e=document.getElementById("model-message-container");return e||(e=document.createElement("div"),e.id="model-message-container",e.className="model-message-overlay",e.style.cssText=`
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                z-index: 1000;
                font-family: 'Poppins', sans-serif;
                min-width: 250px;
                display: none;
            `,(document.getElementById("camera-container")||document.querySelector(".camera-container")||document.body).appendChild(e),this.addMessageStyles()),e}addMessageStyles(){if(document.getElementById("model-message-styles"))return;const e=document.createElement("style");e.id="model-message-styles",e.textContent=`
            .model-loading {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .loading-spinner {
                width: 40px;
                height: 40px;
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-top: 4px solid #fff;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .loading-progress {
                width: 200px;
                height: 6px;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 3px;
                overflow: hidden;
            }
            
            .progress-bar {
                height: 100%;
                background: linear-gradient(90deg, #4CAF50, #8BC34A);
                width: 0%;
                transition: width 0.3s ease;
            }
            
            .model-error {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .error-icon {
                font-size: 32px;
            }
            
            .retry-btn {
                background: #ff6b6b;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 5px;
                cursor: pointer;
                font-family: 'Poppins', sans-serif;
                transition: background 0.3s ease;
            }
            
            .retry-btn:hover {
                background: #ff5252;
            }
            
            .model-success {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .success-icon {
                font-size: 32px;
            }
        `,document.head.appendChild(e)}retryModelLoading(){this.currentGLBModel&&this.currentGLBModel.path?(console.log("Retrying 3D model loading..."),this.loadGlassesModel(this.currentGLBModel.path)):this.show3DModelError("No 3D model to retry loading")}startDetection(){const e=async()=>{try{const t=performance.now();this.video.readyState===4&&(this.faceMesh&&this.faceDetectionEnabled&&this.faceDetectionActive&&t-this.lastDetectionTime>=this.detectionInterval&&(this.lastDetectionTime=t,await this.faceMesh.send({image:this.video})),this.render3D()),this.animationId=requestAnimationFrame(e)}catch(t){console.warn("Detection error:",t),this.animationId=requestAnimationFrame(e)}};e()}getPerformanceStats(){return{faceDetectionEnabled:this.faceDetectionEnabled,faceDetectionActive:this.faceDetectionActive,faceDetected:this.faceDetected,detectionInterval:this.detectionInterval,glassesVisible:this.glassesModel?this.glassesModel.visible:!1}}debug3DModel(){const e={hasGlassesModel:!!this.glassesModel,modelVisible:this.glassesModel?this.glassesModel.visible:!1,modelPosition:this.glassesModel?this.glassesModel.position:null,modelScale:this.glassesModel?this.glassesModel.scale:null,sceneChildren:this.scene?this.scene.children.length:0,rendererSize:this.renderer?this.renderer.getSize(new THREE.Vector2):null,cameraPosition:this.camera?this.camera.position:null};return console.log("3D Model Debug Status:",e),this.glassesModel&&(this.glassesModel.visible=!0,console.log("Forced model visibility to true")),e}adjustPerformance(){const e=performance.now();if(this.lastFrameTime){const s=1e3/(e-this.lastFrameTime),i=this.qualitySettings[this.performanceMode].targetFPS;this.performanceHistory||(this.performanceHistory=[]),this.performanceHistory.push(s),this.performanceHistory.length>30&&this.performanceHistory.shift();const a=this.performanceHistory.reduce((o,r)=>o+r,0)/this.performanceHistory.length;if(a<i*.7&&this.performanceMode!=="low"){const o=["high","medium","low"],r=o.indexOf(this.performanceMode);r<o.length-1&&(this.performanceMode=o[r+1],console.log(`Performance downgrade to ${this.performanceMode} mode (avg FPS: ${a.toFixed(1)})`),this.applyQualitySettings())}else if(a>i*1.2&&this.performanceMode!=="high"){const o=["low","medium","high"],r=o.indexOf(this.performanceMode);r<o.length-1&&(this.performanceMode=o[r+1],console.log(`Performance upgrade to ${this.performanceMode} mode (avg FPS: ${a.toFixed(1)})`),this.applyQualitySettings())}s<20?this.detectionInterval=Math.min(100,this.detectionInterval+10):s>45&&(this.detectionInterval=Math.max(16,this.detectionInterval-5))}this.lastFrameTime=e}applyQualitySettings(){if(this.renderer&&this.scene){const e=this.qualitySettings[this.performanceMode],t=Math.floor(this.canvas.width*e.renderScale),s=Math.floor(this.canvas.height*e.renderScale);this.renderer.setSize(t,s),e.shadowMapSize>0&&!this.deviceCapabilities.isMobile?(this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.setSize(e.shadowMapSize,e.shadowMapSize)):this.renderer.shadowMap.enabled=!1,console.log(`Applied ${this.performanceMode} quality settings - Render size: ${t}x${s}`)}}resizeCanvas(){const e=this.video.getBoundingClientRect();this.canvas.width=e.width,this.canvas.height=e.height,this.renderer&&this.renderer.setSize(this.canvas.width,this.canvas.height),this.camera&&(this.camera.aspect=this.canvas.width/this.canvas.height,this.camera.updateProjectionMatrix())}capturePhoto(){const e=document.createElement("canvas"),t=e.getContext("2d");e.width=this.video.videoWidth,e.height=this.video.videoHeight,t.drawImage(this.video,0,0),this.glassesModel&&this.faceDetected&&t.drawImage(this.canvas,0,0);const s=document.createElement("a");s.download=`virtual-try-on-${Date.now()}.png`,s.href=e.toDataURL(),s.click()}async switchCamera(){try{if((await navigator.mediaDevices.enumerateDevices()).filter(s=>s.kind==="videoinput").length>1){const s=this.video.srcObject.getVideoTracks()[0],a=s.getSettings().facingMode||"user",o=a==="user"?"environment":"user";console.log(`Switching camera from ${a} to ${o}`),s.stop();const r={video:{facingMode:{exact:o},width:{ideal:1280,min:640},height:{ideal:720,min:480}},audio:!1};try{const c=await navigator.mediaDevices.getUserMedia(r);return this.video.srcObject=c,new Promise(l=>{this.video.onloadedmetadata=()=>{this.video.play().then(()=>{this.resizeCanvas(),console.log("Camera switched successfully"),l()})}})}catch{console.log("Exact facing mode failed, trying without exact constraint");const l={video:{facingMode:o,width:{ideal:1280,min:640},height:{ideal:720,min:480}},audio:!1},h=await navigator.mediaDevices.getUserMedia(l);return this.video.srcObject=h,new Promise(d=>{this.video.onloadedmetadata=()=>{this.video.play().then(()=>{this.resizeCanvas(),console.log("Camera switched successfully (fallback)"),d()})}})}}else console.log("Only one camera available, cannot switch"),this.showTemporaryMessage("Only one camera available")}catch(e){console.error("Error switching camera:",e);try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:!1});this.video.srcObject=t}catch(t){console.error("Failed to restore camera:",t),this.showError("Camera switching failed. Please refresh the page.")}}}showTemporaryMessage(e){const t=document.createElement("div");t.style.cssText=`
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            z-index: 10000;
            pointer-events: none;
        `,t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},2e3)}hideLoading(){const e=document.getElementById("loadingOverlay");e&&(e.style.display="none")}showError(e){const t=document.getElementById("loadingOverlay");t&&(t.innerHTML=`
                <div class="error-message">
                    <h3>Error</h3>
                    <p>${e}</p>
                    <button onclick="location.reload()" style="margin-top: 10px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Try Again
                    </button>
                </div>
            `)}destroy(){this.animationId&&cancelAnimationFrame(this.animationId),this.video&&this.video.srcObject&&this.video.srcObject.getTracks().forEach(e=>e.stop()),this.faceMesh&&this.faceMesh.close()}};if(typeof window<"u"&&!window.virtualTryOn){let n;document.querySelector('script[type="module"]')||(document.addEventListener("DOMContentLoaded",()=>{n=new U}),window.addEventListener("beforeunload",()=>{n&&n.destroy()}),window.addEventListener("resize",()=>{n&&n.resizeCanvas()}))}export{U as V};
//# sourceMappingURL=virtual-try-on-CN7LyYq1.js.map
