<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Orders - Trinity Optimum Vision Center</title>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@300;400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="CSS/BaseStyles.css">
    <link rel="stylesheet" href="CSS/AboutUsPageStyles.css">
    <link rel="stylesheet" href="CSS/AdminPageStyles.css">
    <link rel="stylesheet" href="CSS/ConfirmationStyles.css">
    <link rel="stylesheet" href="CSS/ContactUsPageStyles.css">
    <link rel="stylesheet" href="CSS/FrameEditStyles.css">
    <link rel="stylesheet" href="CSS/FrameTypesMenuHeaderStyles.css">
    <link rel="stylesheet" href="CSS/HeaderStyles.css">
    <link rel="stylesheet" href="CSS/LogInModalStyles.css">
    <link rel="stylesheet" href="CSS/NotificationIconPanelStyles.css">
    <link rel="stylesheet" href="CSS/Pre-OrderStyles.css">
    <link rel="stylesheet" href="CSS/ProductGridStyles.css">
    <link rel="stylesheet" href="CSS/ResponsiveNotifStyles.css">
    <link rel="stylesheet" href="CSS/SidebarStyles.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <!-- Firebase Configuration (must be loaded first) -->
    <script src="JS/FirebaseConfig.js"></script>
    
    <!-- Application Scripts (loaded after Firebase is initialized) -->
    <script src="JS/AuthHandlers.js"></script>
    <script src="JS/ContentEditingFunc.js"></script>
    <script src="JS/EventListenerFunc.js"></script>
    <script src="JS/FrameCategoryFunc.js"></script>
    <script src="JS/FrameEditingModal.js"></script>
    <script src="JS/NotificationFunc.js"></script>
    <script src="JS/PassToggleFunc.js"></script>
    <script src="JS/Script.js"></script>
    <script src="JS/SeachFunc.js"></script>
    <script src="JS/SidebarFunc.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <h1 class="maintitle">T R I N I T Y</h1>
                <p class="subtitle">OPTIMUM VISION CENTER</p>
            </div>
            <nav class="nav">
                <div class="nav-left">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="contact.html" class="nav-link">Contact Us</a>
                    <a href="about.html" class="nav-link">About Us</a>
                    <a href="admin-dashboard.html" class="nav-link admin-only" id="adminDashboardNav" style="display: none;">Admin Dashboard</a>
                    <a href="preorders.html" class="nav-link active admin-only">Pre-Orders</a>
                </div>
                <div class="nav-right">
                    <div class="nav-icons">
                        <div class="notification-wrapper">
                            <span class="notification-icon" onclick="toggleNotifications()">üîî</span>
                            <span class="notification-badge" id="notificationBadge">0</span>
                        </div>
                    </div>
                    <div class="auth-section">
                        <a href="login.html" class="login-btn" id="authButton">
                            <span class="user-icon">üë§</span>
                            <span id="authButtonText">Log In</span>
                        </a>
                        <div class="admin-dropdown" id="adminDropdown">
                            <button class="dropdown-item" onclick="switchToGuestMode()">Logout</button>
                            <button class="dropdown-item" onclick="switchToGuestMode()">Switch to Guest View</button>
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Admin Navigation Area -->
        <div class="admin-nav-area" id="adminNavArea" style="display: block;">
            <div class="admin-nav-container">
                <div class="admin-nav-title">
                    <span class="admin-icon">‚öôÔ∏è</span>
                    <h3>Admin Panel</h3>
                </div>
                <nav class="admin-nav">
                    <a href="admin-dashboard.html" class="admin-nav-link">
                        <span class="nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                    <a href="preorders.html" class="admin-nav-link active">
                        <span class="nav-icon">üìã</span>
                        <span>Pre-Orders</span>
                    </a>
                    <a href="#" class="admin-nav-link" onclick="toggleContentManagement()">
                        <span class="nav-icon">üìù</span>
                        <span>Content Management</span>
                    </a>
                    <a href="#" class="admin-nav-link" onclick="toggleUserManagement()">
                        <span class="nav-icon">üë•</span>
                        <span>User Management</span>
                    </a>
                    <a href="#" class="admin-nav-link" onclick="toggleAdminSettings()">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span>Settings</span>
                    </a>
                </nav>
            </div>
        </div>

        <!-- Notifications Panel -->
        <div class="notifications-panel" id="notificationsPanel">
            <div class="notifications-header">
                <h3>Pre-Order Notifications</h3>
                <span class="close-notifications" onclick="hideNotifications()">√ó</span>
            </div>
            <div class="notifications-list" id="notificationsList">
                <div class="empty-notifications">
                    <p>No pre-orders yet</p>
                </div>
            </div>
        </div>

        <!-- Pre-Orders Content -->
        <main class="preorders-admin-content">
            <h2 class="preorders-title">PRE-ORDERS MANAGEMENT</h2>
            
            <div class="preorders-stats">
                <div class="stat-card">
                    <h3>Total Pre-Orders</h3>
                    <p class="stat-number" id="total-preorders">0</p>
                </div>
                <div class="stat-card">
                    <h3>Pending Orders</h3>
                    <p class="stat-number" id="pending-preorders">0</p>
                </div>
                <div class="stat-card">
                    <h3>Completed Orders</h3>
                    <p class="stat-number" id="completed-preorders">0</p>
                </div>
            </div>

            <div class="preorders-list">
                <h3>Recent Pre-Orders</h3>
                <div id="preorders-container">
                    <!-- Pre-orders will be loaded here dynamically -->
                    <div class="loading-message">Loading pre-orders...</div>
                </div>
            </div>
        </main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is authenticated
            firebase.auth().onAuthStateChanged(function(user) {
                // Also check for hardcoded admin login
                const isAdminLoggedIn = localStorage.getItem('isAdminLoggedIn') === 'true';
                
                if (user || isAdminLoggedIn) {
                    // User is signed in or using hardcoded admin credentials
                    loadPreOrders();
                } else {
                    // No user is signed in, redirect to login page
                    window.location.href = 'login.html';
                }
            });
        });

        // Function to load pre-orders from Firebase
        function loadPreOrders() {
            const preOrdersRef = firebase.database().ref('preOrders');
            const preordersContainer = document.getElementById('preorders-container');
            
            // Clear loading message
            preordersContainer.innerHTML = '';
            
            // Initialize counters
            let totalOrders = 0;
            let pendingOrders = 0;
            let completedOrders = 0;
            
            preOrdersRef.on('value', function(snapshot) {
                const preOrders = snapshot.val();
                
                if (preOrders) {
                    // Convert object to array and sort by date (newest first)
                    const preOrdersArray = Object.entries(preOrders).map(([id, order]) => {
                        return { id, ...order };
                    }).sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    totalOrders = preOrdersArray.length;
                    
                    // Clear container before adding new items
                    preordersContainer.innerHTML = '';
                    
                    // Display each pre-order
                    preOrdersArray.forEach(order => {
                        // Update counters
                        if (order.status === 'completed') {
                            completedOrders++;
                        } else {
                            pendingOrders++;
                        }
                        
                        // Create pre-order item element
                        const preOrderItem = document.createElement('div');
                        preOrderItem.className = 'preorder-item';
                        
                        // Format date
                        const orderDate = new Date(order.date);
                        const formattedDate = orderDate.toISOString().split('T')[0];
                        
                        preOrderItem.innerHTML = `
                            <div class="preorder-info">
                                <h4>${order.frameName || 'Custom Frame'}</h4>
                                <p>Customer: ${order.firstName} ${order.lastName}</p>
                                <p>Email: ${order.email}</p>
                                <p>Phone: ${order.phone}</p>
                                <p>Date: ${formattedDate}</p>
                                <p>Status: ${order.status || 'Pending'}</p>
                            </div>
                            <div class="preorder-actions">
                                <button class="admin-btn" onclick="viewOrderDetails('${order.id}')">View Details</button>
                                <button class="admin-btn ${order.status === 'completed' ? 'completed' : ''}" 
                                    onclick="toggleOrderStatus('${order.id}', '${order.status || 'pending'}')">
                                    ${order.status === 'completed' ? 'Mark as Pending' : 'Mark as Completed'}
                                </button>
                                <button class="delete-btn" onclick="deleteOrder('${order.id}')">
                                    <span>üóëÔ∏è</span>
                                    <span>Delete</span>
                                </button>
                            </div>
                        `;
                        
                        preordersContainer.appendChild(preOrderItem);
                    });
                    
                    // Update stats
                    document.getElementById('total-preorders').textContent = totalOrders;
                    document.getElementById('pending-preorders').textContent = pendingOrders;
                    document.getElementById('completed-preorders').textContent = completedOrders;
                } else {
                    // No pre-orders found
                    preordersContainer.innerHTML = '<div class="empty-message">No pre-orders found</div>';
                    
                    // Update stats to zero
                    document.getElementById('total-preorders').textContent = '0';
                    document.getElementById('pending-preorders').textContent = '0';
                    document.getElementById('completed-preorders').textContent = '0';
                }
            });
        }
        
        // Function to view order details
        function viewOrderDetails(orderId) {
            const preOrdersRef = firebase.database().ref('preOrders/' + orderId);
            
            preOrdersRef.once('value', function(snapshot) {
                const order = snapshot.val();
                if (order) {
                    // Format order details for display
                    const details = `
                        Order ID: ${orderId}\n
                        Customer: ${order.firstName} ${order.lastName}\n
                        Email: ${order.email}\n
                        Phone: ${order.phone}\n
                        Frame: ${order.frameName || 'Custom Frame'}\n
                        Prescription: ${order.prescription || 'Not provided'}\n
                        Additional Notes: ${order.notes || 'None'}\n
                        Date: ${new Date(order.date).toISOString().split('T')[0]}\n
                        Status: ${order.status || 'Pending'}
                    `;
                    
                    alert(details);
                } else {
                    alert('Order not found');
                }
            });
        }
        
        // Function to toggle order status
        function toggleOrderStatus(orderId, currentStatus) {
            const newStatus = currentStatus === 'completed' ? 'pending' : 'completed';
            const preOrdersRef = firebase.database().ref('preOrders/' + orderId);
            
            preOrdersRef.update({
                status: newStatus
            }).then(() => {
                console.log(`Order ${orderId} status updated to ${newStatus}`);
                // The UI will update automatically due to the Firebase listener
            }).catch(error => {
                console.error('Error updating order status:', error);
                alert('Error updating order status: ' + error.message);
            });
        }
        
        // Function to delete order
        function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                const preOrdersRef = firebase.database().ref('preOrders/' + orderId);
                
                preOrdersRef.remove().then(() => {
                    console.log(`Order ${orderId} deleted successfully`);
                    // The UI will update automatically due to the Firebase listener
                }).catch(error => {
                    console.error('Error deleting order:', error);
                    alert('Error deleting order: ' + error.message);
                });
            }
        }
    </script>
</body>
</html>