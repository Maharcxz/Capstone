<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Orders - Trinity Optimum Vision Center</title>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@300;400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="CSS/BaseStyles.css">
    <link rel="stylesheet" href="CSS/AboutUsPageStyles.css">
    <link rel="stylesheet" href="CSS/AdminPageStyles.css">
    <link rel="stylesheet" href="CSS/ConfirmationStyles.css">
    <link rel="stylesheet" href="CSS/ContactUsPageStyles.css">
    <link rel="stylesheet" href="CSS/FrameEditStyles.css">
    <link rel="stylesheet" href="CSS/FrameTypesMenuHeaderStyles.css">
    <link rel="stylesheet" href="CSS/HeaderStyles.css">
    <link rel="stylesheet" href="CSS/LogInModalStyles.css">
    <link rel="stylesheet" href="CSS/NotificationIconPanelStyles.css">
    <link rel="stylesheet" href="CSS/Pre-OrderStyles.css">
    <link rel="stylesheet" href="CSS/ProductGridStyles.css">
    <link rel="stylesheet" href="CSS/ResponsiveNotifStyles.css">
    <link rel="stylesheet" href="CSS/SidebarStyles.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <!-- Firebase Configuration (must be loaded first) -->
    <script src="JS/FirebaseConfig.js"></script>
    
    <!-- Application Scripts (loaded after Firebase is initialized) -->
    <script src="JS/AuthHandlers.js"></script>
    <script src="JS/ContentEditingFunc.js"></script>
    <script src="JS/EventListenerFunc.js"></script>
    <script src="JS/FrameCategoryFunc.js"></script>
    <script src="JS/FrameEditingModal.js"></script>
    <script src="JS/NotificationFunc.js"></script>
    <script src="JS/PassToggleFunc.js"></script>
    <script src="JS/Script.js"></script>
    <script src="JS/SeachFunc.js"></script>
    <script src="JS/SidebarFunc.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <h1 class="maintitle">T R I N I T Y</h1>
                <p class="subtitle">OPTIMUM VISION CENTER</p>
            </div>
            <nav class="nav">
                <div class="nav-left">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="contact.html" class="nav-link">Contact Us</a>
                    <a href="about.html" class="nav-link">About Us</a>
                    <a href="admin-dashboard.html" class="nav-link admin-only" id="adminDashboardNav" style="display: none;">Admin Dashboard</a>
                    <a href="preorders.html" class="nav-link active admin-only">Pre-Orders</a>
                </div>
                <div class="nav-right">
                    <div class="nav-icons">
                        <div class="notification-wrapper">
                            <span class="notification-icon" onclick="toggleNotifications()">üîî</span>
                            <span class="notification-badge" id="notificationBadge">0</span>
                        </div>
                    </div>
                    <div class="auth-section">
                        <a href="#" class="login-btn" id="authButton" onclick="handleAuthClick()">
                            <span class="user-icon">üë§</span>
                            <span id="authButtonText">Log In</span>
                        </a>
                        <div class="admin-dropdown" id="adminDropdown">
                            <button class="dropdown-item" onclick="switchToGuestMode()">Logout</button>
                            <button class="dropdown-item" onclick="switchToGuestMode()">Switch to Guest View</button>
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Admin Navigation Area -->
        <div class="admin-nav-area" id="adminNavArea" style="display: block;">
            <div class="admin-nav-container">
                <div class="admin-nav-title">
                    <span class="admin-icon">‚öôÔ∏è</span>
                    <h3>Admin Panel</h3>
                </div>
                <nav class="admin-nav">
                    <a href="admin-dashboard.html" class="admin-nav-link">
                        <span class="nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                    <a href="preorders.html" class="admin-nav-link active">
                        <span class="nav-icon">üìã</span>
                        <span>Pre-Orders</span>
                    </a>
                    <a href="#" class="admin-nav-link" onclick="toggleContentManagement()">
                        <span class="nav-icon">üìù</span>
                        <span>Content Management</span>
                    </a>
                    <a href="#" class="admin-nav-link" onclick="toggleUserManagement()">
                        <span class="nav-icon">üë•</span>
                        <span>User Management</span>
                    </a>
                    <a href="#" class="admin-nav-link" onclick="toggleAdminSettings()">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span>Settings</span>
                    </a>
                </nav>
            </div>
        </div>

        <!-- Notifications Panel -->
        <div class="notifications-panel" id="notificationsPanel">
            <div class="notifications-header">
                <h3>Pre-Order Notifications</h3>
                <span class="close-notifications" onclick="hideNotifications()">√ó</span>
            </div>
            <div class="notifications-list" id="notificationsList">
                <div class="empty-notifications">
                    <p>No pre-orders yet</p>
                </div>
            </div>
        </div>

        <!-- Pre-Orders Content -->
        <main class="preorders-admin-content">
            <h2 class="preorders-title">PRE-ORDERS MANAGEMENT</h2>
            
            <div class="preorders-stats">
                <div class="stat-card">
                    <h3>Total Pre-Orders</h3>
                    <p class="stat-number" id="total-preorders">0</p>
                </div>
                <div class="stat-card">
                    <h3>Pending Orders</h3>
                    <p class="stat-number" id="pending-preorders">0</p>
                </div>
                <div class="stat-card">
                    <h3>Completed Orders</h3>
                    <p class="stat-number" id="completed-preorders">0</p>
                </div>
            </div>

            <div class="preorders-list">
                <div class="preorders-header">
                    <h3 id="orders-section-title">Recent Pre-Orders</h3>
                    <div class="filter-dropdown">
                        <select id="orderFilter" class="order-filter-select" onchange="filterOrders()">
                            <option value="pending">Pre-Orders</option>
                            <option value="completed">Completed Orders</option>
                        </select>
                    </div>
                </div>
                <div id="preorders-container">
                    <!-- Pre-orders will be loaded here dynamically -->
                    <div class="loading-message">Loading pre-orders...</div>
                </div>
            </div>
        </main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is authenticated (without adding another auth state listener)
            const user = firebase.auth().currentUser;
            const isAdminLoggedIn = localStorage.getItem('isAdminLoggedIn') === 'true';
            
            if (user || isAdminLoggedIn) {
                // User is signed in or using hardcoded admin credentials
                loadPreOrders();
            } else {
                // Authentication state will be handled by AuthHandlers.js
                // Just load preorders for now, AuthHandlers will redirect if needed
                loadPreOrders();
            }
        });

        // Function to load pre-orders from Firebase
        function loadPreOrders() {
            const preOrdersRef = firebase.database().ref('preOrders');
            const preordersContainer = document.getElementById('preorders-container');
            
            // Clear loading message
            preordersContainer.innerHTML = '';
            
            // Initialize counters
            let totalOrders = 0;
            let pendingOrders = 0;
            let completedOrders = 0;
            
            preOrdersRef.on('value', function(snapshot) {
                const preOrders = snapshot.val();
                
                if (preOrders) {
                    // Convert object to array and sort by date (newest first)
                    const preOrdersArray = Object.entries(preOrders).map(([id, order]) => {
                        return { id, ...order };
                    }).sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    totalOrders = preOrdersArray.length;
                    
                    // Clear container before adding new items
                    preordersContainer.innerHTML = '';
                    
                    // Store all orders globally for filtering
                    window.allOrders = preOrdersArray;
                    
                    // Display orders based on current filter
                    displayFilteredOrders();
                    
                    // Update counters
                    preOrdersArray.forEach(order => {
                        if (order.status === 'completed') {
                            completedOrders++;
                        } else {
                            pendingOrders++;
                        }
                    });
                    
                    // Update stats
                     document.getElementById('total-preorders').textContent = totalOrders;
                     document.getElementById('pending-preorders').textContent = pendingOrders;
                     document.getElementById('completed-preorders').textContent = completedOrders;
                     
                     // Update notification badge
                     updateNotificationBadge(pendingOrders);
                } else {
                    // No pre-orders found
                    preordersContainer.innerHTML = '<div class="empty-message">No pre-orders found</div>';
                    
                    // Update stats to zero
                    document.getElementById('total-preorders').textContent = '0';
                    document.getElementById('pending-preorders').textContent = '0';
                    document.getElementById('completed-preorders').textContent = '0';
                }
            });
        }
        
        // Function to view order details
        function viewOrderDetails(orderId) {
            console.log('Viewing details for order:', orderId);
            
            // Get order data from Firebase
            const preOrdersRef = firebase.database().ref('preOrders/' + orderId);
            preOrdersRef.once('value').then(snapshot => {
                const order = snapshot.val();
                if (order) {
                    populateOrderModal(order, orderId);
                    showOrderDetailsModal();
                } else {
                    alert('Order not found');
                }
            }).catch(error => {
                console.error('Error fetching order details:', error);
                alert('Error loading order details: ' + error.message);
            });
        }
        
        // Function to populate modal with order data
        function populateOrderModal(order, orderId) {
            // Customer Information
            document.getElementById('modal-customer-name').textContent = `${order.firstName || ''} ${order.lastName || ''}`.trim();
            document.getElementById('modal-customer-email').textContent = order.email || 'N/A';
            document.getElementById('modal-customer-phone').textContent = order.phone || 'N/A';
            
            // Order Information
            document.getElementById('modal-product-name').textContent = order.productName || 'N/A';
            
            // Format date
            const orderDate = order.timestamp ? new Date(order.timestamp).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : 'N/A';
            document.getElementById('modal-order-date').textContent = orderDate;
            
            // Status with styling
            const statusElement = document.getElementById('modal-order-status');
            const status = order.status || 'pending';
            statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            statusElement.style.color = status === 'completed' ? '#28a745' : '#ffc107';
            statusElement.style.fontWeight = '600';
            
            // Prescription Details (if available)
            const prescriptionSection = document.getElementById('modal-prescription-section');
            if (order.prescription) {
                prescriptionSection.style.display = 'block';
                document.getElementById('modal-prescription-od').textContent = order.prescription.rightEye || 'N/A';
                document.getElementById('modal-prescription-os').textContent = order.prescription.leftEye || 'N/A';
                document.getElementById('modal-prescription-pd').textContent = order.prescription.pd || 'N/A';
            } else {
                prescriptionSection.style.display = 'none';
            }
            
            // Additional Notes (if available)
            const notesSection = document.getElementById('modal-notes-section');
            if (order.notes && order.notes.trim()) {
                notesSection.style.display = 'block';
                document.getElementById('modal-notes').textContent = order.notes;
            } else {
                notesSection.style.display = 'none';
            }
        }
        
        // Function to show the modal
        function showOrderDetailsModal() {
            document.getElementById('orderDetailsModal').style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
        
        // Function to close the modal
        function closeOrderDetailsModal() {
            document.getElementById('orderDetailsModal').style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('orderDetailsModal');
            if (event.target === modal) {
                closeOrderDetailsModal();
            }
        }
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeOrderDetailsModal();
            }
        })
        
        // Function to load pre-orders from Firebase
        function loadPreOrders() {
            const preOrdersRef = firebase.database().ref('preOrders');
            const preordersContainer = document.getElementById('preorders-container');
            
            // Clear loading message
            preordersContainer.innerHTML = '';
            
            // Initialize counters
            let totalOrders = 0;
            let pendingOrders = 0;
            let completedOrders = 0;
            
            preOrdersRef.on('value', function(snapshot) {
                const preOrders = snapshot.val();
                
                if (preOrders) {
                    // Convert object to array and sort by date (newest first)
                    const preOrdersArray = Object.entries(preOrders).map(([id, order]) => {
                        return { id, ...order };
                    }).sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    totalOrders = preOrdersArray.length;
                    
                    // Clear container before adding new items
                    preordersContainer.innerHTML = '';
                    
                    // Store all orders globally for filtering
                    window.allOrders = preOrdersArray;
                    
                    // Display orders based on current filter
                    displayFilteredOrders();
                    
                    // Update counters
                    preOrdersArray.forEach(order => {
                        if (order.status === 'completed') {
                            completedOrders++;
                        } else {
                            pendingOrders++;
                        }
                    });
                    
                    // Update stats
                    document.getElementById('total-preorders').textContent = totalOrders;
                    document.getElementById('pending-preorders').textContent = pendingOrders;
                    document.getElementById('completed-preorders').textContent = completedOrders;
                } else {
                    // No pre-orders found
                    preordersContainer.innerHTML = '<div class="empty-message">No pre-orders found</div>';
                    
                    // Update stats to zero
                    document.getElementById('total-preorders').textContent = '0';
                    document.getElementById('pending-preorders').textContent = '0';
                    document.getElementById('completed-preorders').textContent = '0';
                }
            });
        }
        
        // Function to display filtered orders
        function displayFilteredOrders() {
            const filterValue = document.getElementById('orderFilter').value;
            const preordersContainer = document.getElementById('preorders-container');
            const titleElement = document.getElementById('orders-section-title');
            
            // Update title based on filter
            titleElement.textContent = filterValue === 'pending' ? 'Recent Pre-Orders' : 'Completed Orders';
            
            // Clear container
            preordersContainer.innerHTML = '';
            
            // Filter orders based on selected value
            const filteredOrders = window.allOrders ? window.allOrders.filter(order => {
                const orderStatus = order.status || 'pending';
                return orderStatus === filterValue;
            }) : [];
            
            // Update stats display based on current filter
            const statsContainer = document.querySelector('.stats-container');
            if (statsContainer) {
                const totalOrders = window.allOrders ? window.allOrders.length : 0;
                const pendingOrders = window.allOrders ? window.allOrders.filter(order => (order.status || 'pending') === 'pending').length : 0;
                const completedOrders = window.allOrders ? window.allOrders.filter(order => order.status === 'completed').length : 0;
                
                // Update the displayed counts
                document.getElementById('total-preorders').textContent = totalOrders;
                document.getElementById('pending-preorders').textContent = pendingOrders;
                document.getElementById('completed-preorders').textContent = completedOrders;
                
                // Update notification badge
                updateNotificationBadge(pendingOrders);
            }
            
            if (filteredOrders.length === 0) {
                preordersContainer.innerHTML = `<div class="loading-message">No ${filterValue === 'pending' ? 'pending' : 'completed'} orders found.</div>`;
                return;
            }
            
            // Display filtered orders
            filteredOrders.forEach(order => {
                const preOrderItem = document.createElement('div');
                preOrderItem.className = 'preorder-item';
                
                // Format date
                const orderDate = new Date(order.date);
                const formattedDate = orderDate.toISOString().split('T')[0];
                
                preOrderItem.innerHTML = `
                    <div class="preorder-info">
                        <h4>${order.frameName || 'Custom Frame'}</h4>
                        <p>Customer: ${order.firstName} ${order.lastName}</p>
                        <p>Email: ${order.email}</p>
                        <p>Phone: ${order.phone}</p>
                        <p>Date: ${formattedDate}</p>
                        <p>Status: ${order.status || 'Pending'}</p>
                    </div>
                    <div class="preorder-actions">
                        <button class="admin-btn" onclick="viewOrderDetails('${order.id}')">View Details</button>
                        <button class="admin-btn ${order.status === 'pending' || !order.status ? 'pending' : ''}" 
                            onclick="toggleOrderStatus('${order.id}', '${order.status || 'pending'}')">
                            ${order.status === 'completed' ? 'Mark as Pending' : 'Mark as Completed'}
                        </button>
                        <button class="delete-btn" onclick="deleteOrder('${order.id}')">
                            <span>üóëÔ∏è</span>
                            <span>Delete</span>
                        </button>
                    </div>
                `;
                
                preordersContainer.appendChild(preOrderItem);
            });
        }
        
        // Function to filter orders when dropdown changes
        function filterOrders() {
            displayFilteredOrders();
        }
        
        // Function to toggle order status
        function toggleOrderStatus(orderId, currentStatus) {
            const newStatus = currentStatus === 'completed' ? 'pending' : 'completed';
            const preOrdersRef = firebase.database().ref('preOrders/' + orderId);
            
            preOrdersRef.update({
                status: newStatus
            }).then(() => {
                console.log(`Order ${orderId} status updated to ${newStatus}`);
                // Reload the orders to reflect changes
                loadPreOrders();
            }).catch(error => {
                console.error('Error updating order status:', error);
                alert('Error updating order status: ' + error.message);
            });
        }
        
        // Function to delete order
        function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                const preOrdersRef = firebase.database().ref('preOrders/' + orderId);
                
                preOrdersRef.remove().then(() => {
                    console.log(`Order ${orderId} deleted successfully`);
                    // The UI will update automatically due to the Firebase listener
                }).catch(error => {
                    console.error('Error deleting order:', error);
                    alert('Error deleting order: ' + error.message);
                });
            }
        }
    </script>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Order Details</h2>
                <span class="close" onclick="closeOrderDetailsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="order-detail-section">
                    <h3>Customer Information</h3>
                    <div class="detail-row">
                        <span class="detail-label">Name:</span>
                        <span id="modal-customer-name"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Email:</span>
                        <span id="modal-customer-email"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Phone:</span>
                        <span id="modal-customer-phone"></span>
                    </div>
                </div>
                
                <div class="order-detail-section">
                    <h3>Order Information</h3>
                    <div class="detail-row">
                        <span class="detail-label">Product:</span>
                        <span id="modal-product-name"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Order Date:</span>
                        <span id="modal-order-date"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span id="modal-order-status"></span>
                    </div>
                </div>
                
                <div class="order-detail-section" id="modal-prescription-section">
                    <h3>Prescription Details</h3>
                    <div class="detail-row">
                        <span class="detail-label">Right Eye (OD):</span>
                        <span id="modal-prescription-od"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Left Eye (OS):</span>
                        <span id="modal-prescription-os"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">PD (Pupillary Distance):</span>
                        <span id="modal-prescription-pd"></span>
                    </div>
                </div>
                
                <div class="order-detail-section" id="modal-notes-section">
                    <h3>Additional Notes</h3>
                    <div class="detail-row">
                        <span id="modal-notes"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="admin-btn" onclick="closeOrderDetailsModal()">Close</button>
            </div>
        </div>
    </div>

</body>
</html>